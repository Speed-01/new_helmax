<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#ff6b00',
            'primary-light': '#ff8533',
            'zinc': {
              800: '#27272a',
              900: '#18181b'
            }
          }
        }
      }
    }
  </script>
  <link href="https://unpkg.com/lucide-icons/dist/umd/lucide.css" rel="stylesheet">
  <style>
    body {
      background-color: black;
      color: white;
    }
    
    .icon {
      display: inline-block;
      width: 1.25rem;
      height: 1.25rem;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
  </style>
</head>
<body class="min-h-screen bg-black text-white">
  {% csrf_token %}
  <div class="flex min-h-screen">
    <!-- Sidebar - Hidden on mobile -->
    <aside class="w-64 bg-[#18181b]/80 backdrop-blur-lg text-white p-6 space-y-6 border-r border-[#334155]/30 hidden md:block">
      <div class="space-y-6">
        <div>
          <h2 class="text-xl font-semibold text-white bg-gradient-to-r from-[#F0F0F0] to-[#ff8533] bg-clip-text text-transparent">Account</h2>
          <nav class="space-y-1.5 mt-6">
            <a href="{% url 'user_profile' user.id %}" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="user" class="icon mr-3"></i>
              My Profile
            </a>
            <a href="{%  url 'my_orders' %}" class="flex items-center px-4 py-3 rounded-xl text-white bg-gradient-to-r from-[#ff6b00] to-[#ff8533] shadow-lg shadow-[#ff6b00]/30">
              <i data-lucide="package" class="icon mr-3"></i>
              Orders
            </a>
            <a href="{% url 'userManageAddress' %}" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="map-pin" class="icon mr-3"></i>
              Address
            </a>
            <a href="{% url 'wallet' %}" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="credit-card" class="icon mr-3"></i>
              Wallet
            </a>
            <a href="{% url 'available_coupons' %}" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="ticket" class="icon mr-3"></i>
              Coupons
            </a>
            <a href="/change-password" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="key" class="icon mr-3"></i>
              Change Password
            </a>
            <a href="/transactions" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="dollar-sign" class="icon mr-3"></i>
              Transaction History
            </a>
            <a href="javascript:void(0);" onclick="openLogoutModal()" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
              <i data-lucide="log-out" class="icon mr-3"></i>
              Logout
            </a>
          </nav>
        </div>
      </div>
    </aside>

    <!-- Mobile menu button -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 md:hidden bg-zinc-800 border border-zinc-700 p-2 rounded-full">
      <i data-lucide="menu" class="icon"></i>
    </button>

    <!-- Mobile sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
      <div class="absolute inset-0 bg-black bg-opacity-50" id="sidebarOverlay"></div>
      <div class="relative w-64 h-full bg-[#18181b]/95 backdrop-blur-lg border-r border-[#334155]/30 p-6 space-y-6 transform transition-transform duration-300 ease-in-out">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-white bg-gradient-to-r from-[#F0F0F0] to-[#ff8533] bg-clip-text text-transparent">Account</h2>
          <button id="closeSidebar" class="text-gray-400 hover:text-white">
            <i data-lucide="x" class="icon"></i>
          </button>
        </div>
        <nav class="space-y-1.5">
          <a href="/profile" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="user" class="icon mr-3"></i>
            My Profile
          </a>
          <a href="/orders" class="flex items-center px-4 py-3 rounded-xl text-white bg-gradient-to-r from-[#ff6b00] to-[#ff8533] shadow-lg shadow-[#ff6b00]/30">
            <i data-lucide="package" class="icon mr-3"></i>
            Orders
          </a>
          <a href="/address" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="map-pin" class="icon mr-3"></i>
            Address
          </a>
          <a href="/wallet" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="credit-card" class="icon mr-3"></i>
            Wallet  
          </a>
          <a href="/coupons" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="ticket" class="icon mr-3"></i>
            Coupons
          </a>
          <a href="/change-password" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="key" class="icon mr-3"></i>
            Change Password
          </a>
          <a href="/transactions" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="dollar-sign" class="icon mr-3"></i>
            Transaction History
          </a>
          <a href="javascript:void(0);" onclick="openLogoutModal()" class="flex items-center px-4 py-3 rounded-xl text-gray-300 hover:bg-[#ff6b00]/10 hover:text-[#ff6b00] transition-all duration-300">
            <i data-lucide="log-out" class="icon mr-3"></i>
            Logout
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-6 md:p-8 overflow-y-auto">
      <div class="max-w-6xl mx-auto">
        <!-- Back Button and Page Title -->
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center space-x-2">
            <a href="{% url 'my_orders' %}" class="inline-flex items-center justify-center rounded-full w-8 h-8 border border-zinc-700 bg-zinc-800 hover:bg-zinc-700 transition-colors">
              <i data-lucide="arrow-left" class="icon h-4 w-4"></i>
            </a>
            <h1 class="text-2xl font-bold">Order Details</h1>
          </div>
          <a href="{% url 'download_invoice' order.order_id %}" class="inline-flex items-center gap-2 px-4 py-2 border border-zinc-700 bg-zinc-800 rounded-md hover:bg-zinc-700 transition-colors">
            <i data-lucide="download" class="icon h-4 w-4"></i>
            Download Invoice
          </a>
        </div>

        <!-- Order Actions -->
        <div class="mb-6 bg-zinc-900 rounded-lg overflow-hidden">
          <div class="p-6">
            <div class="flex space-x-4">
                {% if order.order_status != 'CANCELLED' and order.order_status != 'DELIVERED' %}
                <button id="cancelOrderBtn" class="px-6 py-2 border border-red-800 text-red-500 hover:bg-red-900/20 rounded-md transition-colors flex items-center">
                  <i data-lucide="x" class="icon mr-2 h-4 w-4"></i>
                  Cancel Order
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const retryBtn = document.getElementById('retry-payment-btn');
    if (retryBtn) {
      retryBtn.addEventListener('click', function() {
        const btn = this;
        const orderId = btn.getAttribute('data-order-id');
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="loader" class="icon mr-2 h-4 w-4 animate-spin"></i>Processing...';
        
        fetch(`/payment/retry/${orderId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const options = {
              key: data.key,
              amount: data.amount,
              currency: 'INR',
              name: 'Helmax',
              description: 'Order Payment',
              order_id: data.order_id,
              handler: function(response) {
                // On payment success, verify with backend
                fetch(`/payment/success/${orderId}/`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_signature: response.razorpay_signature
                    })
                  })
                  .then(res => res.json())
                  .then(resData => {
                    window.location.href = resData.redirect_url;
                  })
                  .catch(() => {
                    window.location.href = '/my-orders/';
                  });
                },
                prefill: {
                  name: data.customer_name,
                  email: data.customer_email,
                  contact: data.customer_phone
                },
                theme: { color: '#ff6b00' }
              };
              const rzp = new Razorpay(options);
              rzp.on('payment.failed', function () {
                window.location.href = '/my-orders/';
              });
              rzp.open();
            } else {
              // Re-enable button and show error
              btn.disabled = false;
              btn.innerHTML = originalText;
              alert(data.message || 'Payment retry failed');
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              }
            }
          })
          .catch(() => {
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('An error occurred. Please try again.');
          });
        });
      }
    });
  </script>

  <!-- Order Status Card -->
        <div class="mb-6 bg-zinc-900 rounded-lg overflow-hidden">
          <div class="p-4 border-b border-zinc-800">
            <h2 class="text-xl font-bold flex items-center">
              <i data-lucide="package" class="icon mr-2 text-[#ff6b00]"></i>
              Order Status
            </h2>
          </div>
          <div class="p-6">
            <!-- Order Status Timeline -->
            {% if order.order_status == 'CANCELLED' %}
            <!-- Cancelled Order Display -->
            <div class="p-6 bg-red-900/30 border border-red-800 rounded-lg text-center">
              <div class="flex justify-center mb-4">
                <div class="w-16 h-16 rounded-full flex items-center justify-center bg-red-900/50 border-2 border-red-600">
                  <i data-lucide="x-circle" class="icon h-8 w-8 text-red-400"></i>
                </div>
              </div>
              <h3 class="text-2xl font-bold text-red-400 mb-2">Order Cancelled</h3>
              <p class="text-red-300 mb-4">{{ order.payment_failure_reason|default:"This order has been cancelled." }}</p>
              <p class="text-sm text-red-200">Cancelled at: {{ order.cancelled_at|date:"F j, Y g:i A" }}</p>
            </div>
            {% else %}
            <div class="relative">
              <div class="flex justify-between items-center">
                <!-- Step 1: Order Placed -->
                <div class="flex flex-col items-center relative z-10">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center status-step bg-[#ff6b00] text-white">
                    <i data-lucide="package" class="icon h-5 w-5"></i>
                  </div>
                  <p class="mt-2 text-sm text-white">Order Placed</p>
                  <p class="text-xs text-gray-400">{{ order.created_at|date:"F j, Y g:i A" }}</p>
                </div>
                
                <!-- Step 2: Processing -->
                <div class="flex flex-col items-center relative z-10">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center status-step {% if order.order_status == 'PROCESSING' or order.order_status == 'SHIPPED' or order.order_status == 'DELIVERED' %}bg-[#ff6b00]{% else %}bg-zinc-800{% endif %} text-white">
                    <i data-lucide="alert-circle" class="icon h-5 w-5"></i>
                  </div>
                  <p class="mt-2 text-sm {% if order.order_status == 'PROCESSING' or order.order_status == 'SHIPPED' or order.order_status == 'DELIVERED' %}text-white{% else %}text-zinc-500{% endif %}">Processing</p>
                  <p class="text-xs text-gray-400">{% if order.processed_at %}{{ order.processed_at|date:"F j, Y g:i A" }}{% endif %}</p>
                </div>
                
                <!-- Step 3: Shipped -->
                <div class="flex flex-col items-center relative z-10">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center status-step {% if order.order_status == 'SHIPPED' or order.order_status == 'DELIVERED' %}bg-[#ff6b00]{% else %}bg-zinc-800{% endif %} text-white">
                    <i data-lucide="truck" class="icon h-5 w-5"></i>
                  </div>
                  <p class="mt-2 text-sm {% if order.order_status == 'SHIPPED' or order.order_status == 'DELIVERED' %}text-white{% else %}text-zinc-500{% endif %}">Shipped</p>
                  <p class="text-xs text-gray-400">{% if order.shipped_at %}{{ order.shipped_at|date:"F j, Y g:i A" }}{% endif %}</p>
                </div>
                
                <!-- Step 4: Delivered -->
                <div class="flex flex-col items-center relative z-10">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center status-step {% if order.order_status == 'DELIVERED' %}bg-[#ff6b00]{% else %}bg-zinc-800{% endif %} text-white">
                    <i data-lucide="check-circle" class="icon h-5 w-5"></i>
                  </div>
                  <p class="mt-2 text-sm {% if order.order_status == 'DELIVERED' %}text-white{% else %}text-zinc-500{% endif %}">Delivered</p>
                  <p class="text-xs text-gray-400">{% if order.delivered_at %}{{ order.delivered_at|date:"F j, Y g:i A" }}{% endif %}</p>
                </div>
              </div>
              
              <!-- Progress bar -->
              <div class="absolute top-5 left-0 right-0 h-0.5 bg-zinc-800">
                <div class="h-full bg-[#ff6b00] transition-all duration-500 {% if order.order_status == 'DELIVERED' %}w-full{% elif order.order_status == 'SHIPPED' %}w-2/3{% elif order.order_status == 'PROCESSING' %}w-1/3{% else %}w-0{% endif %}"></div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Order Information Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Order Details -->
          <div class="bg-zinc-900 rounded-lg overflow-hidden">
            <div class="p-4 border-b border-zinc-800">
              <h2 class="text-lg font-bold flex items-center">
                <i data-lucide="calendar" class="icon mr-2 text-[#ff6b00]"></i>
                Order Information
              </h2>
              {% if order.payment_status == 'PAYMENT_PENDING' %}
              <div class="mt-4">
                <button id="retry-payment-btn" 
                        data-order-id="{{ order.order_id }}"
                        class="w-full px-4 py-2 bg-[#ff6b00] hover:bg-[#ff8533] text-black font-medium rounded-md transition-colors flex items-center justify-center gap-2">
                  <i data-lucide="refresh-cw" class="icon h-4 w-4"></i>
                  Retry Payment
                </button>
              </div>
              {% endif %}
            </div>
            <div class="p-6 space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-400">Order ID:</span>
                <span class="font-medium">{{ order.order_id }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Order Date:</span>
                <span>{{ order.created_at|date:"F j, Y \a\t g:i A" }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Payment Method:</span>
                <span>{{ order.payment_method }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Payment Status:</span>
                <div class="flex items-center gap-3">
                  <span class="px-2 py-1 text-xs font-medium rounded-full
                    {% if order.payment_status == 'PAID' %}
                      bg-green-900/50 text-green-300 border border-green-800
                    {% elif order.payment_status == 'FAILED' or order.payment_status == 'PAYMENT_PENDING' %}
                      bg-red-900/50 text-red-300 border border-red-800
                    {% else %}
                      bg-yellow-900/50 text-yellow-300 border border-yellow-800
                    {% endif %}">
                    {{ order.payment_status }}
                  </span>
                </div>
              </div>
              {% if order.payment_failure_reason %}
              <div class="mt-2 p-3 bg-red-900/30 border border-red-800 rounded-md">
                <p class="text-sm text-red-300">Last payment failed: {{ order.payment_failure_reason }}</p>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="bg-zinc-900 rounded-lg overflow-hidden">
            <div class="p-4 border-b border-zinc-800">
              <h2 class="text-lg font-bold flex items-center">
                <i data-lucide="map-pin" class="icon mr-2 text-[#ff6b00]"></i>
                Shipping Address
              </h2>
            </div>
            <div class="p-6 space-y-3">
              <div class="flex items-center space-x-3">
                <div class="h-10 w-10 rounded-full bg-[#ff6b00]/20 text-[#ff6b00] flex items-center justify-center">
                  <span class="text-lg font-semibold">{{ order.full_name.0 }}</span>
                </div>
                <div>
                  <p class="font-medium">{{ order.full_name }}</p>
                  <p class="text-sm text-gray-400">{{ order.phone }}</p>
                </div>
              </div>
              <div class="h-px bg-zinc-800 my-3"></div>
              <div class="text-gray-400 space-y-1">
                <p>{{ order.address_line1 }}</p>
                {% if order.address_line2 %}
                  <p>{{ order.address_line2 }}</p>
                {% endif %}
                <p>{{ order.city }}, {{ order.state }}</p>
                <p>PIN: {{ order.pincode }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="mb-6 bg-zinc-900 rounded-lg overflow-hidden">
          <div class="p-4 border-b border-zinc-800">
            <h2 class="text-xl font-bold flex items-center">
              <i data-lucide="package" class="icon mr-2 text-[#ff6b00]"></i>
              Order Items
            </h2>
          </div>
          <div class="p-6">
            <div class="space-y-6" id="orderItems">
              {% for item in order.order_items.all %}
              <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4 pb-6 border-b border-zinc-800" id="item-{{ item.id }}" data-item-id="{{ item.id }}">
                <div class="flex-shrink-0">
                  <img 
                    src="{{ item.variant.images.first.image.url }}" 
                    alt="{{ item.product.name }}" 
                    class="w-24 h-24 object-cover rounded-lg bg-zinc-800"
                  >
                </div>
                <div class="flex-1">
                  <h4 class="font-medium text-lg">{{ item.product.name }}</h4>
                  <p class="text-gray-400">Qty: {{ item.quantity }}</p>
                  <div class="mt-2">
                    <p class="text-[#ff6b00] font-bold">₹{{ item.price }}</p>
                    {% if item.item_discount > 0 %}
                    <p class="text-sm text-gray-400">
                      <span class="line-through">₹{{ item.original_price }}</span>
                      <span class="text-green-400 ml-2">Save ₹{{ item.item_discount }}</span>
                    </p>
                    {% endif %}
                  </div>
                </div>
                <div class="flex flex-col items-end space-y-3">
                  <div class="text-right">
                    <p class="text-sm text-gray-400 mb-2">
                      Item Status: 
                      <span class="px-3 py-1 rounded-full text-sm 
                        {% if item.status == 'PROCESSING' %}
                          bg-yellow-900/50 text-yellow-300
                        {% elif item.status == 'SHIPPED' %}
                          bg-blue-900/50 text-blue-300
                        {% elif item.status == 'DELIVERED' %}
                          bg-green-900/50 text-green-300
                        {% elif item.status == 'CANCELLED' %}
                          bg-red-900/50 text-red-300
                        {% elif item.status == 'RETURNED' %}
                          bg-gray-800 text-gray-300
                        {% endif %}">
                        {{ item.status }}
                      </span>
                    </p>

                    {% if item.admin_response %}
                    <div class="text-sm text-gray-400 mb-2">
                      <p class="font-medium">Admin Response:</p>
                      <p>{{ item.admin_response }}</p>
                    </div>
                    {% endif %}
                  </div>
                  <div class="flex flex-col space-y-2 w-full md:w-auto">
                    {% if item.status == 'PROCESSING' or item.status == 'SHIPPED' %}
                    <button 
                      onclick="openConfirmationModal('{{ item.id }}', 'Cancel Item', 'Are you sure you want to cancel this item? This action cannot be undone.', 'cancelItem')" 
                      class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm transition-colors">
                      <i data-lucide="x" class="icon mr-1 inline-block h-4 w-4"></i>
                      Cancel Item
                    </button>
                    {% endif %}

                    {% if item.status == 'DELIVERED' and item.return_status == 'NOT_REQUESTED' %}
                    <div class="flex space-x-2">
                      <button 
                        onclick="openReturnModal('{{ item.id }}')" 
                        class="px-3 py-2 bg-[#ff6b00] hover:bg-[#ff8533] text-black font-medium rounded-md text-sm transition-colors">
                        <i data-lucide="rotate-ccw" class="icon mr-1 inline-block h-4 w-4"></i>
                        Return Item
                      </button>
                      {% if not item.has_review %}
                      <button 
                        onclick="openReviewModal('{{ item.id }}', '{{ item.variant.product.name }}', '{{ item.variant.images.first.image.url }}')" 
                        class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md text-sm transition-colors">
                        <i data-lucide="star" class="icon mr-1 inline-block h-4 w-4"></i>
                        Write Review
                      </button>
                      {% else %}
                      <button 
                        onclick="viewReview('{{ item.id }}')" 
                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                        <i data-lucide="eye" class="icon mr-1 inline-block h-4 w-4"></i>
                        View Review
                      </button>
                      {% endif %}
                    </div>
                    
                    <!-- Show review if exists -->
                    {% if item.has_review and item.review %}
                    <div class="mt-3 p-3 bg-zinc-800 rounded-md border border-zinc-700">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                          <span class="text-sm font-medium text-white">Your Review:</span>
                          <div class="flex">
                            {% for i in "12345" %}
                              <svg class="w-4 h-4 {% if forloop.counter <= item.review.rating %}text-yellow-400{% else %}text-gray-600{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                              </svg>
                            {% endfor %}
                          </div>
                          {% if item.review.is_approved %}
                          <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">Approved</span>
                          {% else %}
                          <span class="text-xs bg-yellow-600 text-white px-2 py-1 rounded">Pending Approval</span>
                          {% endif %}
                        </div>
                      </div>
                      <h4 class="text-sm font-medium text-white mb-1">{{ item.review.title }}</h4>
                      <p class="text-sm text-gray-300">{{ item.review.comment|truncatewords:20 }}</p>
                      {% if item.review.images.count > 0 %}
                      <div class="flex space-x-2 mt-2">
                        {% for img in item.review.images.all|slice:":3" %}
                        <img src="{{ img.image.url }}" alt="Review image" class="w-12 h-12 object-cover rounded border border-gray-600">
                        {% endfor %}
                        {% if item.review.images.count > 3 %}
                        <div class="w-12 h-12 bg-zinc-700 rounded flex items-center justify-center text-xs text-gray-400">
                          +{{ item.review.images.count|add:"-3" }}
                        </div>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                    {% endif %}
                    {% elif item.return_status == 'REQUESTED' or item.return_status == 'PENDING' %}
                    <div class="text-yellow-500 text-center py-2 bg-yellow-900/30 border border-yellow-800 rounded-md text-sm">
                      <i data-lucide="clock" class="icon mr-1 inline-block h-4 w-4"></i>
                      Return Request Pending
                    </div>
                    {% elif item.return_status == 'APPROVED' %}
                    <div class="text-green-500 text-center py-2 bg-green-900/30 border border-green-800 rounded-md text-sm">
                      <i data-lucide="check" class="icon mr-1 inline-block h-4 w-4"></i>
                      Return Approved
                    </div>
                    {% elif item.return_status == 'REJECTED' %}
                    <div class="text-red-500 text-center py-2 bg-red-900/30 border border-red-800 rounded-md text-sm">
                      <i data-lucide="x" class="icon mr-1 inline-block h-4 w-4"></i>
                      Return Rejected
                      {% if item.admin_response %}
                      <p class="text-sm text-gray-400 mt-1">{{ item.admin_response }}</p>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Order Summary Card -->
            <div class="mb-6 bg-zinc-900 rounded-lg overflow-hidden">
              <div class="p-4 border-b border-zinc-800">
                <h2 class="text-xl font-bold flex items-center">
                  <i data-lucide="credit-card" class="icon mr-2 text-[#ff6b00]"></i>
                  Order Summary
                </h2>
              </div>
              <div class="p-6">
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Subtotal</span>
                    <span class="text-white">₹{{ order.subtotal }}</span>
                  </div>
                  {% if order.product_discount > 0 or order.calculated_product_discount > 0 %}
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Product Discount</span>
                    <span class="text-green-400">-₹{% if order.product_discount > 0 %}{{ order.product_discount }}{% else %}{{ order.calculated_product_discount }}{% endif %}</span>
                  </div>
                  {% endif %}
                  {% if order.coupon_discount > 0 %}
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Coupon Discount</span>
                    <span class="text-green-400">-₹{{ order.coupon_discount }}</span>
                  </div>
                  {% endif %}
                  <div class="pt-3 border-t border-zinc-800">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-400 font-medium">You Paid</span>
                      <span class="text-white font-bold text-lg">₹{{ order.actual_paid_amount|floatformat:2 }}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                      You saved ₹{% if order.product_discount > 0 %}{{ order.product_discount|floatformat:2 }}{% else %}{{ order.calculated_product_discount|floatformat:2 }}{% endif %}{% if order.coupon_discount > 0 %} + ₹{{ order.coupon_discount|floatformat:2 }}{% endif %} on this order
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Return Modal -->
  <div id="returnModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-[#1A1A1A] p-6 rounded-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Return Request</h2>
        <button onclick="closeReturnModal()" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="icon"></i>
        </button>
      </div>
      <p class="text-gray-400 mb-4">Please provide details about your return request.</p>
      <form id="returnForm" class="space-y-4">
        <input type="hidden" id="returnItemId" name="itemId">
        
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Reason for Return</label>
          <select id="returnReason" name="reason" 
                  class="w-full bg-[#242424] text-white border border-[#2A2A2A] rounded-md px-3 py-2" required>
            <option value="">Select a reason</option>
            <option value="defective">Product Defective</option>
            <option value="wrong_item">Wrong Item Received</option>
            <option value="not_as_described">Item Not As Described</option>
            <option value="size_issue">Size/Fit Issue</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Description</label>
          <textarea id="returnDescription" name="description" 
                    class="w-full bg-[#242424] text-white border border-[#2A2A2A] rounded-md px-3 py-2 min-h-[100px]" 
                    placeholder="Provide a detailed description (10-500 characters)..."
                    maxlength="500"
                    required></textarea>
          <div class="flex justify-between items-center text-xs">
            <span class="text-gray-500">Minimum 10 characters required</span>
            <span id="returnCharCount" class="text-gray-400">
              <span id="returnCurrentChars">0</span> / 500
            </span>
          </div>
        </div>
        
        <div class="flex justify-end space-x-2 pt-2">
          <button type="button" onclick="closeReturnModal()" 
                  class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
            Cancel
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-[#ff6b00] text-black font-medium rounded-md hover:bg-[#ff8533] transition-colors">
            Submit Request
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-[#1A1A1A] p-6 rounded-lg max-w-2xl w-full mx-4 my-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Write a Review</h2>
        <button onclick="closeReviewModal()" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="icon"></i>
        </button>
      </div>
      
      <!-- Product Info -->
      <div class="flex items-center space-x-4 mb-6 pb-4 border-b border-gray-700">
        <img id="reviewProductImage" src="" alt="Product" class="w-16 h-16 object-cover rounded">
        <div>
          <p id="reviewProductName" class="text-white font-medium"></p>
        </div>
      </div>
      
      <form id="reviewForm" class="space-y-4" enctype="multipart/form-data">
        <input type="hidden" id="reviewOrderItemId" name="orderItemId">
        
        <!-- Star Rating -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Rating <span class="text-red-500">*</span></label>
          <div class="flex items-center space-x-2">
            <div class="flex space-x-1" id="starRating">
              <button type="button" class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors" data-rating="1">★</button>
              <button type="button" class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors" data-rating="2">★</button>
              <button type="button" class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors" data-rating="3">★</button>
              <button type="button" class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors" data-rating="4">★</button>
              <button type="button" class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors" data-rating="5">★</button>
            </div>
            <span id="ratingText" class="text-gray-400"></span>
          </div>
          <input type="hidden" id="reviewRating" name="rating" required>
        </div>
        
        <!-- Review Title -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Review Title <span class="text-red-500">*</span></label>
          <input type="text" id="reviewTitle" name="title" 
                 class="w-full bg-[#242424] text-white border border-[#2A2A2A] rounded-md px-3 py-2" 
                 placeholder="Summarize your experience..."
                 maxlength="100"
                 required>
        </div>
        
        <!-- Review Comment -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Your Review <span class="text-red-500">*</span></label>
          <textarea id="reviewComment" name="comment" 
                    class="w-full bg-[#242424] text-white border border-[#2A2A2A] rounded-md px-3 py-2 min-h-[120px]" 
                    placeholder="Share your experience with this product..."
                    maxlength="1000"
                    required></textarea>
          <div class="flex justify-between items-center text-xs">
            <span class="text-gray-500">Share details about quality, fit, and your experience</span>
            <span class="text-gray-400">
              <span id="reviewCurrentChars">0</span> / 1000
            </span>
          </div>
        </div>
        
        <!-- Review Images -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Add Photos (Optional)</label>
          <div class="flex items-center space-x-4">
            <label for="reviewImages" class="cursor-pointer flex items-center space-x-2 px-4 py-2 bg-[#242424] border border-[#2A2A2A] rounded-md hover:bg-[#2A2A2A] transition-colors">
              <i data-lucide="camera" class="icon"></i>
              <span class="text-white">Upload Images</span>
            </label>
            <input type="file" id="reviewImages" name="images" accept="image/*" multiple class="hidden" onchange="previewImages(this)">
            <span class="text-gray-400 text-sm">Max 5 images</span>
          </div>
          <div id="imagePreview" class="flex flex-wrap gap-2 mt-2"></div>
        </div>
        
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-700">
          <button type="button" onclick="closeReviewModal()" 
                  class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
            Cancel
          </button>
          <button type="submit" 
                  class="px-4 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition-colors">
            Submit Review
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Review Modal -->
  <div id="viewReviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-[#1A1A1A] p-6 rounded-lg max-w-2xl w-full mx-4 my-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Your Review</h2>
        <button onclick="closeViewReviewModal()" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="icon"></i>
        </button>
      </div>
      
      <div id="reviewContent" class="space-y-4">
        <!-- Review content will be populated by JavaScript -->
      </div>
      
      <div class="flex justify-end mt-6 pt-4 border-t border-gray-700">
        <button onclick="closeViewReviewModal()" 
                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-[#1A1A1A] p-6 rounded-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 id="confirmationTitle" class="text-xl font-bold text-white">Confirmation</h2>
        <button onclick="closeConfirmationModal()" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="icon"></i>
        </button>
      </div>
      <p id="confirmationMessage" class="text-gray-300 mb-6">Are you sure you want to proceed?</p>
      
      <div class="flex justify-end space-x-2">
        <button onclick="closeConfirmationModal()" 
                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
          No, Cancel
        </button>
        <button id="confirmButton"
                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
          Yes, Proceed
        </button>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
    <div class="bg-[#1A1A1A] p-6 rounded-lg max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Logout Confirmation</h2>
        <button onclick="closeLogoutModal()" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="icon"></i>
        </button>
      </div>
      <p class="text-gray-300 mb-6">Are you sure you want to log out?</p>
      <form method="post" action="{% url 'confirm_logout' %}" class="flex justify-end space-x-4">
        {% csrf_token %}
        <button type="button" class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-zinc-700 transition-colors" onclick="closeLogoutModal()">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Yes, log me out</button>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    function closeLogoutModal() {
      document.getElementById('logoutModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Close the modal when clicking outside of it
    window.onclick = function(event) {
      if (event.target == document.getElementById('logoutModal')) {
        closeLogoutModal();
      }
    }
    
    // Mobile sidebar functionality
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.remove('-translate-x-full');
    });
    
    document.getElementById('closeSidebar').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.add('-translate-x-full');
    });
    
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.add('-translate-x-full');
    });
    
    // Return Modal functionality
    let currentItemId = null;
    
    function openReturnModal(itemId) {
      document.getElementById('returnItemId').value = itemId;
      document.getElementById('returnModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeReturnModal() {
      document.getElementById('returnModal').classList.add('hidden');
      document.getElementById('returnForm').reset();
      document.body.style.overflow = '';
    }
    
    // Confirmation Modal functionality
    let confirmCallback = null;
    
    function openConfirmationModal(itemId, title, message, callbackName) {
      currentItemId = itemId;
      document.getElementById('confirmationTitle').textContent = title;
      document.getElementById('confirmationMessage').textContent = message;
      
      // Set the callback function based on the name
      if (callbackName === 'cancelItem') {
        confirmCallback = function() {
          cancelItem(currentItemId);
        };
      }
      
      document.getElementById('confirmButton').onclick = function() {
        if (confirmCallback) confirmCallback();
      };
      
      document.getElementById('confirmationModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.add('hidden');
      document.body.style.overflow = '';
      currentItemId = null;
      confirmCallback = null;
    }
    
    // Validation Error Display Function
    function showReturnValidationError(message) {
      // Remove any existing validation error
      const existingError = document.getElementById('returnValidationError');
      if (existingError) {
        existingError.remove();
      }

      // Create new validation error
      const errorElement = document.createElement('div');
      errorElement.id = 'returnValidationError';
      errorElement.className = 'mt-2 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm flex items-start gap-2';
      errorElement.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
        <span>${message}</span>
      `;

      // Insert after textarea
      const textarea = document.getElementById('returnDescription');
      textarea.parentNode.insertBefore(errorElement, textarea.nextSibling.nextSibling);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (document.getElementById('returnValidationError')) {
          errorElement.style.opacity = '0';
          errorElement.style.transition = 'opacity 0.3s ease';
          setTimeout(() => errorElement.remove(), 300);
        }
      }, 5000);
    }

    // Character counter for return description
    document.getElementById('returnDescription').addEventListener('input', function() {
      const currentLength = this.value.length;
      const charCountSpan = document.getElementById('returnCurrentChars');
      const charCountContainer = document.getElementById('returnCharCount');
      
      if (charCountSpan) {
        charCountSpan.textContent = currentLength;
        
        // Change color based on character count
        if (currentLength < 10) {
          charCountContainer.className = 'text-red-400';
        } else if (currentLength > 450) {
          charCountContainer.className = 'text-yellow-400';
        } else {
          charCountContainer.className = 'text-green-400';
        }
      }

      // Remove validation error on input
      const existingError = document.getElementById('returnValidationError');
      if (existingError) {
        existingError.remove();
      }
    });

    // Form submission handlers
    document.getElementById('returnForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const itemId = document.getElementById('returnItemId').value;
      const reason = document.getElementById('returnReason').value;
      const description = document.getElementById('returnDescription').value.trim();
      
      // Validation 1: Check if description is empty
      if (!description) {
        showReturnValidationError('Please enter a description for your return request');
        document.getElementById('returnDescription').focus();
        return;
      }

      // Validation 2: Check if reason is selected
      if (!reason) {
        showReturnValidationError('Please select a reason for return');
        document.getElementById('returnReason').focus();
        return;
      }

      // Validation 3: Check minimum length (at least 10 characters)
      if (description.length < 10) {
        showReturnValidationError('Description must be at least 10 characters long');
        document.getElementById('returnDescription').focus();
        return;
      }

      // Validation 4: Check maximum length (max 500 characters)
      if (description.length > 500) {
        showReturnValidationError('Description must not exceed 500 characters');
        document.getElementById('returnDescription').focus();
        return;
      }

      // Validation 5: Check for valid characters (no special characters only)
      const validTextPattern = /^[a-zA-Z0-9\s\.,!?'-]+$/;
      if (!validTextPattern.test(description)) {
        showReturnValidationError('Description contains invalid characters. Please use only letters, numbers, and basic punctuation');
        document.getElementById('returnDescription').focus();
        return;
      }

      // Validation 6: Check if it's not just spaces or punctuation
      const meaningfulText = description.replace(/[\s\.,!?'-]/g, '');
      if (meaningfulText.length < 5) {
        showReturnValidationError('Please provide a meaningful description with actual content');
        document.getElementById('returnDescription').focus();
        return;
      }
      
      fetch(`/api/order-items/${itemId}/return/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          reason: reason,
          description: description
        })
      })
      .then(response => response.json())
      .then(data => {
        closeReturnModal();
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || 'Failed to submit return request');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting the return request');
      });
    });

    
    function cancelItem(itemId) {
      fetch(`/api/order-items/${itemId}/cancel/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        closeConfirmationModal();
        if (data.success) {
          // Update item status
          const itemElement = document.getElementById(`item-${itemId}`);
          const statusSpan = itemElement.querySelector('.rounded-full');
          statusSpan.className = 'px-3 py-1 rounded-full text-sm bg-red-900/50 text-red-300 border border-red-800';
          statusSpan.textContent = 'CANCELLED';
          
          // Remove cancel button
          const cancelButton = itemElement.querySelector('button');
          if (cancelButton) {
            cancelButton.remove();
          }
          
          // Update order totals if provided
          if (data.new_total !== undefined) {
            document.getElementById('orderSubtotal').textContent = `₹${data.new_total.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `₹${data.new_total.toFixed(2)}`;
          }
          
          // Show refund message if applicable
          if (data.refund_amount > 0) {
            const refundMsg = document.createElement('p');
            refundMsg.className = 'text-green-500 text-sm mt-2';
            refundMsg.textContent = `₹${data.refund_amount.toFixed(2)} has been refunded to your wallet`;
            itemElement.appendChild(refundMsg);
          }
          
          // Reload if all items are cancelled
          if (data.new_total === 0) {
            location.reload();
          }
        } else {
          alert(data.message || 'Failed to cancel item');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while cancelling the item');
      });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // Review Modal functionality
    let selectedRating = 0;
    
    function openReviewModal(orderItemId, productName, productImage) {
      document.getElementById('reviewOrderItemId').value = orderItemId;
      document.getElementById('reviewProductName').textContent = productName;
      document.getElementById('reviewProductImage').src = productImage;
      document.getElementById('reviewModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Reset form
      document.getElementById('reviewForm').reset();
      selectedRating = 0;
      updateStarRating(0);
      document.getElementById('imagePreview').innerHTML = '';
      
      // Reinitialize lucide icons
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    function closeReviewModal() {
      document.getElementById('reviewModal').classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // Star rating functionality
    const starButtons = document.querySelectorAll('.star-btn');
    const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
    
    starButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const rating = parseInt(this.dataset.rating);
        selectedRating = rating;
        document.getElementById('reviewRating').value = rating;
        document.getElementById('ratingText').textContent = ratingTexts[rating];
        updateStarRating(rating);
      });
      
      btn.addEventListener('mouseenter', function() {
        const rating = parseInt(this.dataset.rating);
        updateStarRating(rating);
      });
    });
    
    document.getElementById('starRating').addEventListener('mouseleave', function() {
      updateStarRating(selectedRating);
    });
    
    function updateStarRating(rating) {
      starButtons.forEach((btn, index) => {
        if (index < rating) {
          btn.classList.remove('text-gray-600');
          btn.classList.add('text-yellow-400');
        } else {
          btn.classList.remove('text-yellow-400');
          btn.classList.add('text-gray-600');
        }
      });
    }
    
    // Character counter for review comment
    document.getElementById('reviewComment').addEventListener('input', function() {
      document.getElementById('reviewCurrentChars').textContent = this.value.length;
    });
    
    // Image preview functionality
    function previewImages(input) {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      if (input.files) {
        const filesArray = Array.from(input.files).slice(0, 5); // Max 5 images
        
        filesArray.forEach((file, index) => {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative';
            div.innerHTML = `
              <img src="${e.target.result}" class="w-20 h-20 object-cover rounded border border-gray-700">
              <button type="button" onclick="removeImage(${index})" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">×</button>
            `;
            preview.appendChild(div);
          };
          
          reader.readAsDataURL(file);
        });
      }
    }
    
    function removeImage(index) {
      const input = document.getElementById('reviewImages');
      const dt = new DataTransfer();
      const files = input.files;
      
      for (let i = 0; i < files.length; i++) {
        if (i !== index) {
          dt.items.add(files[i]);
        }
      }
      
      input.files = dt.files;
      previewImages(input);
    }
    
    // Review form submission
    document.getElementById('reviewForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate rating
      if (selectedRating === 0) {
        alert('Please select a rating (1-5 stars)');
        return;
      }
      
      // Validate title
      const title = document.getElementById('reviewTitle').value.trim();
      if (title.length < 3) {
        alert('Review title must be at least 3 characters long');
        return;
      }
      
      // Validate comment
      const comment = document.getElementById('reviewComment').value.trim();
      if (comment.length < 10) {
        alert('Review comment must be at least 10 characters long');
        return;
      }
      
      // Disable submit button to prevent double submission
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      const formData = new FormData();
      const orderItemId = document.getElementById('reviewOrderItemId').value;
      formData.append('rating', selectedRating);
      formData.append('title', title);
      formData.append('comment', comment);
      
      // Add images
      const images = document.getElementById('reviewImages').files;
      for (let i = 0; i < Math.min(images.length, 5); i++) {
        formData.append('images', images[i]);
      }
      
      fetch(`/review/submit/${orderItemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Show success message with custom styling
          const successMsg = document.createElement('div');
          successMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-8 py-6 rounded-lg shadow-2xl z-[60] text-center';
          successMsg.innerHTML = `
            <div class="text-4xl mb-3">✓</div>
            <h3 class="text-xl font-bold mb-2">Review Submitted!</h3>
            <p class="text-sm">Your review will be visible after admin approval.</p>
          `;
          document.body.appendChild(successMsg);
          
          closeReviewModal();
          
          // Remove message and reload after 2.5 seconds
          setTimeout(() => {
            successMsg.remove();
            location.reload();
          }, 2500);
        } else {
          alert(data.message || 'Failed to submit review. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Unable to submit review. Please check your connection and try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    });
    
    // View review functionality
    function viewReview(orderItemId) {
      // Find the item element
      const itemElement = document.querySelector(`[data-item-id="${orderItemId}"]`);
      if (!itemElement) {
        alert('Review not found');
        return;
      }
      
      // Get review data from the rendered review div
      const reviewDiv = itemElement.querySelector('.bg-zinc-800');
      if (!reviewDiv) {
        alert('Review details not available');
        return;
      }
      
      // Clone and enhance the review content for modal display
      const reviewContent = document.getElementById('reviewContent');
      const clone = reviewDiv.cloneNode(true);
      
      // Make it look better in the modal
      clone.classList.remove('mt-3', 'p-3', 'bg-zinc-800', 'border-zinc-700');
      clone.classList.add('p-4', 'bg-[#222222]', 'rounded-lg', 'border', 'border-gray-700');
      
      // Expand truncated text
      const commentPara = clone.querySelector('p.text-sm.text-gray-300');
      if (commentPara) {
        commentPara.classList.remove('truncate');
      }
      
      // Enlarge images
      const images = clone.querySelectorAll('img');
      images.forEach(img => {
        img.classList.remove('w-12', 'h-12');
        img.classList.add('w-24', 'h-24', 'cursor-pointer');
        img.onclick = function() {
          window.open(this.src, '_blank');
        };
      });
      
      reviewContent.innerHTML = '';
      reviewContent.appendChild(clone);
      
      document.getElementById('viewReviewModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Reinitialize lucide icons
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    function closeViewReviewModal() {
      document.getElementById('viewReviewModal').classList.add('hidden');
      document.body.style.overflow = '';
    }
  </script>
</body>
</html>