
{% extends 'base.html' %}
{% load static %}
{% load offer_filters %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% comment %} <!-- Breadcrumb -->
    <nav class="mb-8 text-sm">
        <ol class="flex items-center space-x-2">
            {% for item in breadcrumb %}
                {% if not forloop.last %}
                    <li><a href="{{ item.url }}" class="text-gray-400 hover:text-gray-300">{{ item.name }}</a></li>
                    <li><span class="text-gray-600 mx-2">/</span></li>
                {% else %}
                    <li><span class="text-[#ff6b00]">{{ item.name }}</span></li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav> {% endcomment %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
        <!-- Left: Product Images -->
        <div class="space-y-4">
            <div id="zoom-container" class="relative bg-[#222222] rounded-lg overflow-hidden">
                <img 
                    id="main-image"
                    src="{{ primary_variant.images.first.image.url }}"
                    alt="{{ product.name }}"
                    class="w-full aspect-square object-cover"
                >
                <div id="zoom-lens" class="zoom-lens hidden"></div>
            </div>
            
            <div class="grid grid-cols-4 gap-4" id="thumbnails">
                {% for image in primary_variant.images.all %}
                <button 
                    class="bg-[#222222] rounded-lg overflow-hidden hover:opacity-80 transition-opacity {% if forloop.first %}thumbnail-active{% endif %}"
                    data-image-url="{{ image.image.url }}"
                >
                    <img 
                        src="{{ image.image.url }}"
                        alt="Product view {{ forloop.counter }}"
                        class="w-full aspect-square object-cover"
                    >
                    
                </button>
                {% endfor %}
                
            </div>
            

        </div>

        <!-- Right: Product Info -->
        <div class="space-y-6">
            <h1 class="text-3xl font-medium text-white">{{ product.name }}</h1>
            
            {% comment %} <div class="flex items-center space-x-4 mt-2">
                <div class="flex items-center">
                    {% for i in "12345"|make_list %}
                        <svg class="w-5 h-5 {% if forloop.counter <= avg_rating|floatformat:'0' %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                    {% endfor %}
                </div>
                <span class="text-sm text-gray-400">{{ avg_rating|floatformat:1 }} ({{ rating_count }} reviews)</span>
            </div> {% endcomment %}

            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-400">Brand: <span class="text-[#ff6b00]">{{ brand }}</span></div>
                <div class="text-sm text-gray-400">Availability: 
                    <span id="stock-status" class="{% if total_stock > 0 %}text-green-500{% else %}text-red-500{% endif %}">
                        {% if total_stock > 0 %}In Stock ({{ total_stock }} available){% else %}Out of Stock{% endif %}
                    </span>
                </div>
            </div>

            
            <div class="flex items-center space-x-4">
                {% with best_offer=product.get_best_offer %}
                    {% if best_offer %}
                        <span id="current-price" class="text-2xl font-medium text-[#ff6b00]">
                            ₹{{ primary_variant.price|calculate_offer_price:best_offer.discount_percentage|floatformat:2 }}
                        </span>
                        <span id="original-price" class="text-gray-500 line-through">₹{{ primary_variant.price|floatformat:2 }}</span>
                        <span class="text-green-500 text-sm">({{ best_offer.discount_percentage|floatformat:2 }}% off)</span>
                    {% else %}
                        <span id="current-price" class="text-2xl font-medium text-[#ff6b00]">
                            ₹{{ primary_variant.price|floatformat:2 }}
                        </span>
                    {% endif %}
                {% endwith %}
            </div>

            <p class="text-gray-400 text-sm leading-relaxed">
                {{ product.description }}
            </p>

            <!-- Variant Image Selection -->
            <div class="space-y-4">
                <label class="text-sm text-gray-400">Color</label>
                <div class="flex space-x-3" id="color-options" data-product-id="{{ product.id }}">
                    {% for item in variants_with_images %}
                        <button 
                            class="w-12 h-12 rounded-sm hover:opacity-80 transition-opacity overflow-hidden "
                            data-variant-id="{{ item.id }}"
                            data-color="{{ item.color }}"
                        >
                            {% if item.primary_image %}
                                <img 
                                    src="{{ item.primary_image.image.url }}" 
                                    alt="{{ item.color }} {{ product.name }}"
                                    class="w-full h-full object-cover"
                                >
                            {% else %}
                                <div 
                                    class="w-full h-full"
                                    style="background-color: {{ item.color }}"
                                ></div>
                            {% endif %}
                            <span class="sr-only">{{ item.color }}</span>
                        </button>
                    {% endfor %}
                </div>
            </div>
                {% comment %} <div class="text-sm text-gray-400">Availability: 
                    <span id="stock-status" class="{% if total_stock > 0 %}text-green-500{% else %}text-red-500{% endif %}">
                        {% if total_stock > 0 %}
                            In Stock ({{ total_stock }} available)
                        {% else %}
                            Out of Stock
                        {% endif %}
                    </span>
                </div> {% endcomment %}
                <!-- Size Selection -->
                <div class="space-y-4">
                    <label class="text-sm text-gray-400">Size</label>
                    <div class="flex flex-wrap gap-3" id="size-options">
                        {% for size in sizes %}
                            <div class="relative flex flex-col items-center">
                                <!-- Size Button -->
                                <button 
                                    class="w-[45px] h-[45px] flex items-center justify-center border 
                                        {% if size.stock > 0 %}border-[#333333] hover:border-[#555555]{% else %}border-gray-600 cursor-not-allowed opacity-50{% endif %} 
                                        rounded-sm transition-colors"
                                    data-size="{{ size.name }}"
                                    {% if size.stock == 0 %}disabled{% endif %}
                                >
                                    <span class="text-sm font-medium {% if size.stock > 0 %}text-gray-200{% else %}text-gray-500{% endif %}">
                                        {{ size.name }}
                                    </span>
                                </button>

                                <!-- Stock Information -->
                                <div class="text-xs mt-1 {% if size.stock > 0 %}text-green-500{% else %}text-red-500{% endif %}">
                                    {% if size.stock > 0 %}
                                        {{ size.stock }} left
                                    {% else %}
                                        Out of stock
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% comment %} <div class="space-y-4">
                    <label class="text-sm text-gray-400">Size</label>
                    <div class="flex flex-wrap gap-3" id="size-options">
                        <!-- Sizes will be dynamically injected here -->
                    </div>
                </div> {% endcomment %}

                <!-- Add to Cart Section -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center bg-[#222222] rounded-sm">
                        <button id="decrease-quantity" class="px-3 py-2 text-gray-400 hover:text-white transition-colors">-</button>
                        <input id="quantity" type="number" value="1" min="1" max="5" class="w-16 bg-transparent text-center text-white">
                        <button id="increase-quantity" class="px-3 py-2 text-gray-400 hover:text-white transition-colors">+</button>
                    </div>
                    
                    <button 
                        id="add-to-cart"
                        class="flex-1 bg-[#ff6b00] text-white px-6 py-3 rounded-sm hover:bg-[#ff7d1a] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        {% if not item.size.stock > 0 %}disabled{% endif %}
                        {% comment %} data-variant-id="{{ total_stock.id }}" {% endcomment %}
                        data-max-stock="{{ size.stock }}"
                    >
                        Add To Cart
                    </button>
                    
                    <!-- Wishlist Heart Button -->
                    <button 
                        id="wishlist-btn"
                        class="w-12 h-12 flex items-center justify-center bg-[#222222] rounded-sm hover:bg-[#333333] transition-colors"
                        data-variant-id="{{ selected_variant_id }}"
                        onclick="toggleWishlist({{ selected_variant_id }}, this);"
                    >
                        <i class="fas fa-heart {% if selected_variant_id in wishlist_variant_ids %}text-red-500{% else %}text-white{% endif %} text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if reviews %}
<div class="mt-12 border-t border-gray-800 pt-8">
    <h2 class="text-2xl font-medium text-white mb-6">Customer Reviews</h2>
    {% for review in reviews %}
    <div class="mb-6 pb-6 border-b border-gray-800 last:border-b-0">
        <div class="flex items-center mb-2">
            <div class="flex items-center">
                {% for i in "12345"|make_list %}
                    <svg class="w-5 h-5 {% if forloop.counter <= review.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                {% endfor %}
            </div>
            <span class="ml-2 text-sm text-gray-400">{{ review.user.username }}</span>
        </div>
        <p class="text-gray-300">{{ review.comment }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}
<!-- Notification -->
<div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-md shadow-md hidden z-50">
    Item added to cart
</div>

<script>
// @ts-nocheck - Django template syntax
document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('main-image');
    const colorOptions = document.getElementById('color-options');
    const sizeOptions = document.getElementById('size-options');
    const quantityInput = document.getElementById('quantity');
    
    // Wishlist toggle function
    window.toggleWishlist = function(variantId, button) {
        // Check if user is authenticated
        const isAuthenticated = {{ request.user.is_authenticated|lower }};
        if (!isAuthenticated) {
            window.location.href = '{% url "Login" %}?next={% url "product_detail" product.id %}';
            return;
        }
        
        // Send request to add/remove from wishlist
        fetch(`/move-to-wishlist/${variantId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Toggle heart icon color
                const heartIcon = button.querySelector('i');
                if (heartIcon.classList.contains('text-white')) {
                    heartIcon.classList.remove('text-white');
                    heartIcon.classList.add('text-red-500');
                    showNotification('Added to wishlist', 'success');
                } else {
                    heartIcon.classList.remove('text-red-500');
                    heartIcon.classList.add('text-white');
                    showNotification('Removed from wishlist', 'success');
                }
                
                // Update wishlist count in header if it exists
                const wishlistCountElement = document.querySelector('.wishlist-count');
                if (wishlistCountElement) {
                    if (data.wishlist_count > 0) {
                        wishlistCountElement.textContent = data.wishlist_count;
                        wishlistCountElement.classList.remove('hidden');
                    } else {
                        wishlistCountElement.classList.add('hidden');
                    }
                }
            } else {
                showNotification(data.message || 'Failed to update wishlist', 'error');
            }
        })
        .catch(error => {
            console.error('Error updating wishlist:', error);
            showNotification('Failed to update wishlist', 'error');
        });
    }
    
    // Update wishlist button based on variant ID
    function updateWishlistButton(variantId) {
        const wishlistButton = document.getElementById('wishlist-btn');
        if (!wishlistButton) return;
        
        const heartIcon = wishlistButton.querySelector('i');
        const wishlistVariantIds = {{ wishlist_variant_ids|safe }};
        
        // Update button data attribute and onclick
        wishlistButton.setAttribute('data-variant-id', variantId);
        wishlistButton.setAttribute('onclick', `toggleWishlist(${variantId}, this);`);
        
        // Update heart icon color based on wishlist status
        if (wishlistVariantIds.includes(parseInt(variantId))) {
            heartIcon.classList.remove('text-white');
            heartIcon.classList.add('text-red-500');
        } else {
            heartIcon.classList.remove('text-red-500');
            heartIcon.classList.add('text-white');
        }
    }
    
    // Show notification function
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white transform transition-all duration-300 flex items-center`;
        
        const icon = document.createElement('i');
        icon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`;
        notification.appendChild(icon);
        
        const text = document.createElement('span');
        text.textContent = message;
        notification.appendChild(text);
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateY(0)';
        }, 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // Get cookie function for CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const addToCartBtn = document.getElementById('add-to-cart');
    const notification = document.getElementById('notification');
    const decreaseQuantityBtn = document.getElementById('decrease-quantity');
    const increaseQuantityBtn = document.getElementById('increase-quantity');
    const zoomContainer = document.getElementById('zoom-container');
    const zoomLens = document.getElementById('zoom-lens');

    // Initialize with the selected variant ID from the server
    let selectedVariantId = {{ selected_variant_id|default:'null' }};
    // Initialize with the default size name from the server
    {% if default_size %}
    let selectedSizeName = "{{ default_size }}";
    {% else %}
    let selectedSizeName = null;
    {% endif %}
    let isZooming = false;
    const zoomLevel = 2.5;
    let selectedSize = null;
    let currentSizes = [];
    
    // Store the default size ID for initial selection
    const defaultSizeId = {{ default_size_id|default:'null' }};

    function initZoom() {
        let zoomResult = document.getElementById('zoom-result');
        if (!zoomResult) {
            zoomResult = document.createElement('div');
            zoomResult.id = 'zoom-result';
            zoomContainer.appendChild(zoomResult); // Append to container instead of body
        }

        const lensSize = 100;
        zoomLens.style.width = lensSize + 'px';
        zoomLens.style.height = lensSize + 'px';

        zoomContainer.addEventListener('mouseenter', startZoom);
        zoomContainer.addEventListener('mouseleave', stopZoom);
        zoomContainer.addEventListener('mousemove', moveZoom);
    }

    function startZoom(e) {
        isZooming = true;
        zoomLens.classList.remove('hidden');
        const zoomResult = document.getElementById('zoom-result');
        zoomResult.style.display = 'block';
        updateZoomPosition(e);
    }

    function stopZoom() {
        isZooming = false;
        zoomLens.classList.add('hidden');
        const zoomResult = document.getElementById('zoom-result');
        zoomResult.style.display = 'none';
    }

    function moveZoom(e) {
        if (!isZooming) return;
        e.preventDefault();
        updateZoomPosition(e);
    }

    function updateZoomPosition(e) {
        const rect = mainImage.getBoundingClientRect();
        const zoomResult = document.getElementById('zoom-result');
        
        // Get cursor position relative to image
        let mouseX = e.clientX - rect.left;
        let mouseY = e.clientY - rect.top;

        // Constrain to image bounds
        mouseX = Math.min(Math.max(mouseX, 0), rect.width);
        mouseY = Math.min(Math.max(mouseY, 0), rect.height);

        // Calculate lens position
        const lensWidth = parseInt(zoomLens.style.width);
        const lensHeight = parseInt(zoomLens.style.height);
        
        let lensX = mouseX - lensWidth / 2;
        let lensY = mouseY - lensHeight / 2;

        // Constrain lens to image bounds
        lensX = Math.min(Math.max(lensX, 0), rect.width - lensWidth);
        lensY = Math.min(Math.max(lensY, 0), rect.height - lensHeight);

        // Update lens position
        zoomLens.style.left = `${lensX}px`;
        zoomLens.style.top = `${lensY}px`;

        // Calculate zoom ratios
        const scaleX = zoomResult.offsetWidth / lensWidth;
        const scaleY = zoomResult.offsetHeight / lensHeight;

        // Update zoom result
        zoomResult.style.backgroundImage = `url(${mainImage.src})`;
        zoomResult.style.backgroundSize = `${rect.width * scaleX}px ${rect.height * scaleY}px`;
        zoomResult.style.backgroundPosition = `-${lensX * scaleX}px -${lensY * scaleY}px`;
    }

    // Initialize zoom
    initZoom();
    
    // Auto-select the default variant when page loads
    function selectDefaultVariant() {
        if (selectedVariantId) {
            // Find the variant button with the matching ID
            const variantButton = colorOptions.querySelector(`button[data-variant-id="${selectedVariantId}"]`);
            if (variantButton) {
                // Add visual selection indicator
                variantButton.classList.add('ring-2', 'ring-[#ff6b00]');
            }
        }
    }
    
    // Auto-select the default size when page loads
    function selectDefaultSize() {
        if (!currentSizes || currentSizes.length === 0) return;
        
        const sizeButtons = document.querySelectorAll('#size-options button');
        let sizeToSelect = null;

        // First try to use previously selected size if it's still available
        if (selectedSizeName) {
            sizeToSelect = Array.from(sizeButtons).find(button => {
                const sizeName = button.dataset.size;
                const sizeData = currentSizes.find(size => size.name === sizeName);
                return sizeName === selectedSizeName && sizeData && sizeData.stock > 0;
            });
        }

        // If no previous size or it's not available, find first available size
        if (!sizeToSelect) {
            sizeToSelect = Array.from(sizeButtons).find(button => {
                const sizeName = button.dataset.size;
                const sizeData = currentSizes.find(size => size.name === sizeName);
                return sizeData && sizeData.stock > 0;
            });
        }

        // If we found a size to select, select it
        if (sizeToSelect) {
            // Remove ring from all buttons
            sizeButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-[#ff6b00]'));
            
            // Add ring to selected button
            sizeToSelect.classList.add('ring-2', 'ring-[#ff6b00]');
            
            // Update selected size name
            selectedSizeName = sizeToSelect.dataset.size;
            
            // Update stock status and enable add to cart button
            const selectedSizeData = currentSizes.find(size => size.name === selectedSizeName);
            if (selectedSizeData) {
                const stockStatus = document.getElementById('stock-status');
                stockStatus.textContent = `In Stock (${selectedSizeData.stock} available)`;
                stockStatus.classList.remove('text-red-500');
                stockStatus.classList.add('text-green-500');
                addToCartBtn.disabled = false;
                
                // Set max quantity based on stock
                addToCartBtn.dataset.maxStock = selectedSizeData.stock;
                quantityInput.max = Math.min(5, selectedSizeData.stock);
                quantityInput.value = 1;
            }
        }
    }

    // Call selectDefaultSize after updating size options
    function updateSizeOptions(sizes) {
        currentSizes = sizes;
        selectDefaultSize();
    }
    
    // Call the auto-select functions after the page is fully loaded
    selectDefaultVariant();
    
    // Fetch the default variant details on page load
    if (selectedVariantId) {
        fetchVariantDetails(selectedVariantId);
    }
    
    // Handle thumbnail clicks
    const thumbnailsContainer = document.getElementById('thumbnails');
    if (thumbnailsContainer) {
        thumbnailsContainer.addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (button) {
                const imageUrl = button.dataset.imageUrl;
                if (imageUrl) {
                    mainImage.src = imageUrl;
                    const zoomResult = document.getElementById('zoom-result');
                    if (zoomResult) {
                        zoomResult.style.backgroundImage = `url(${imageUrl})`;
                    }
                }
            }
        });
    }

    // Variant fetching and updating
    async function fetchVariantDetails(variantId) {
        try {
            const response = await fetch(`/product/{{ product.id }}/variant/${variantId}/`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

            const data = await response.json();
            updateProductInfo(data);
            
            // Store current selected size before updating options
            const previousSelectedSize = selectedSizeName;
            
            // Update size options and try to maintain selection
            updateSizeOptions(data.sizes);
            
            // Update main image and thumbnails
            if (data.images && data.images.length > 0) {
                updateImages(data.images);
                
                // Update zoom result background
                const zoomResult = document.getElementById('zoom-result');
                if (zoomResult) {
                    const primaryImage = data.images.find(img => img.is_primary) || data.images[0];
                    zoomResult.style.backgroundImage = `url(${primaryImage.image})`;
                }
            }
            
            // Try to select the same size if it exists in new variant
            if (previousSelectedSize) {
                selectedSizeName = previousSelectedSize;
                selectDefaultSize();
            }
            
            // Update wishlist button for new variant
            updateWishlistButton(variantId);

        } catch (error) {
            console.error('Error fetching variant data:', error);
            showNotification('Error fetching variant data. Please try again.', 'error');
        }
    }

    // Auto-select the default variant when page loads
    function selectDefaultVariant() {
        if (selectedVariantId) {
            // Find the variant button with the matching ID
            const variantButton = colorOptions.querySelector(`button[data-variant-id="${selectedVariantId}"]`);
            if (variantButton) {
                // Add visual selection indicator
                variantButton.classList.add('ring-2', 'ring-[#ff6b00]');
            }
        }
    }
    
    // Color selection handling
    colorOptions.addEventListener('click', async function(e) {
        const button = e.target.closest('button');
        if (button) {
            const variantId = button.dataset.variantId;
            selectedVariantId = variantId;
            
            button.classList.add('opacity-50');
            
            try {
                await fetchVariantDetails(variantId);
                
                colorOptions.querySelectorAll('button').forEach(btn =>
                    btn.classList.remove('ring-2', 'ring-[#ff6b00]'));
                button.classList.add('ring-2', 'ring-[#ff6b00]');
                
            } catch (error) {
                console.error('Error updating variant:', error);
                showNotification('Error updating variant details', 'error');
            } finally {
                button.classList.remove('opacity-50');
            }
        }
    });

    function updateProductInfo(data) {
        const currentPriceElement = document.getElementById('current-price');
        const originalPriceElement = document.getElementById('original-price');
        const stockStatus = document.getElementById('stock-status');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        
        if (!currentPriceElement || !originalPriceElement || !stockStatus || !addToCartBtn) {
            console.error('Required elements not found');
            return;
        }
        
        currentPriceElement.textContent = `₹${data.final_price}`;
        if (data.discount_price) {
            originalPriceElement.textContent = `₹${data.price}`;
            originalPriceElement.classList.remove('hidden');
        } else {
            originalPriceElement.classList.add('hidden');
        }
        
        // Update stock status based on selected size
        if (selectedSizeName) {
            const selectedSize = data.sizes.find(size => size.name === selectedSizeName);
            if (selectedSize) {
                if (selectedSize.stock > 0) {
                    stockStatus.textContent = `In Stock (${selectedSize.stock} available)`;
                    stockStatus.classList.remove('text-red-500');
                    stockStatus.classList.add('text-green-500');
                    addToCartBtn.disabled = false;
                } else {
                    stockStatus.textContent = 'Out of Stock';
                    stockStatus.classList.remove('text-green-500');
                    stockStatus.classList.add('text-red-500');
                    addToCartBtn.disabled = true;
                }
            }
        } else {
            // If no size is selected, show total stock
            if (data.total_stock > 0) {
                stockStatus.textContent = `In Stock (${data.total_stock} available)`;
                stockStatus.classList.remove('text-red-500');
                stockStatus.classList.add('text-green-500');
                addToCartBtn.disabled = false;
            } else {
                stockStatus.textContent = 'Out of Stock';
                stockStatus.classList.remove('text-green-500');
                stockStatus.classList.add('text-red-500');
                addToCartBtn.disabled = true;
            }
        }
        
        if (data.images && data.images.length > 0) {
            updateImages(data.images);
        }
        
        addToCartBtn.dataset.variantId = data.id;
        addToCartBtn.dataset.maxStock = data.total_stock;
        
        quantityInput.value = 1;
        quantityInput.max = data.s;
        
        updateSizeOptions(data.sizes);
    }

    // Update images function with zoom support
    function updateImages(images) {
        const mainImage = document.getElementById('main-image');
        const thumbnailsContainer = document.getElementById('thumbnails');
        const zoomResult = document.getElementById('zoom-result');
        
        const primaryImage = images.find(img => img.is_primary) || images[0];
        
        // Update main image
        if (mainImage) {
            mainImage.src = primaryImage.image;
            mainImage.alt = primaryImage.alt_text || 'Product view';
        }
        
        // Update zoom result background if it exists
        if (zoomResult) {
            zoomResult.style.backgroundImage = `url(${primaryImage.image})`;
        }
        
        // Update thumbnails
        if (thumbnailsContainer) {
            thumbnailsContainer.innerHTML = images.map((image, index) => `
                <button 
                    class="bg-[#222222] rounded-lg overflow-hidden hover:opacity-80 transition-opacity ${image.is_primary ? 'thumbnail-active' : ''}"
                    data-image-url="${image.image}"
                >
                    <img 
                        src="${image.image}"
                        alt="${image.alt_text || `Product view ${index + 1}`}"
                        class="w-full aspect-square object-cover"
                    >
                </button>
            `).join('');
            
            // Add click event listeners to new thumbnails
            thumbnailsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function() {
                    const imageUrl = this.dataset.imageUrl;
                    
                    // Update main image
                    if (mainImage) {
                        mainImage.src = imageUrl;
                    }
                    
                    // Update zoom result background
                    if (zoomResult) {
                        zoomResult.style.backgroundImage = `url(${imageUrl})`;
                    }
                    
                    // Update active thumbnail state
                    thumbnailsContainer.querySelectorAll('button').forEach(btn => 
                        btn.classList.remove('thumbnail-active'));
                    this.classList.add('thumbnail-active');
                });
            });
        }
    }

    function updateSizeOptions(sizes) {
        currentSizes = sizes; // Store sizes data globally
        sizeOptions.innerHTML = sizes.map(size => `
            <div class="relative flex flex-col items-center">
                <button 
                    class="w-[45px] h-[45px] flex items-center justify-center border 
                        ${size.stock > 0 ? 
                            'border-[#333333] hover:border-[#555555]' : 
                            'border-gray-600 cursor-not-allowed opacity-50'}
                        rounded-sm transition-colors"
                    data-size="${size.name}"
                    data-stock="${size.stock}"
                    ${size.stock === 0 ? 'disabled' : ''}
                >
                    <span class="text-sm font-medium 
                        ${size.stock > 0 ? 'text-gray-200' : 'text-gray-500'}">
                        ${size.name}
                    </span>
                </button>
                <div class="text-xs mt-1 ${size.stock > 0 ? 'text-green-500' : 'text-red-500'}">
                    ${size.stock > 0 ? `${size.stock} left` : 'Out of stock'}
                </div>
            </div>
        `).join('');

        // Re-bind size selection handlers
        document.querySelectorAll('#size-options button').forEach(button => {
            if (!button.disabled) {
                button.addEventListener('click', handleSizeSelection);
            }
        });
        
        // Select the default size if available
        selectDefaultSize();
    }

    // Update handleSizeSelection to store selected size and update quantity limits
    function handleSizeSelection(e) {
        const button = e.currentTarget;
        document.querySelectorAll('#size-options button').forEach(btn => 
            btn.classList.remove('ring-2', 'ring-[#ff6b00]')
        );
        
        button.classList.add('ring-2', 'ring-[#ff6b00]');
        selectedSizeName = button.dataset.size;
        
        // Find the selected size data
        const selectedSizeData = currentSizes.find(size => size.name === selectedSizeName);
        
        if (selectedSizeData) {
            // Update stock status
            const stockStatus = document.getElementById('stock-status');
            if (selectedSizeData.stock > 0) {
                stockStatus.textContent = `In Stock (${selectedSizeData.stock} available)`;
                stockStatus.classList.remove('text-red-500');
                stockStatus.classList.add('text-green-500');
                addToCartBtn.disabled = false;
                
                // Update quantity input max value based on selected size stock
                quantityInput.max = selectedSizeData.stock;
                // Reset quantity to 1 if current quantity exceeds new max
                if (parseInt(quantityInput.value) > selectedSizeData.stock) {
                    quantityInput.value = 1;
                }
            } else {
                stockStatus.textContent = 'Out of Stock';
                stockStatus.classList.remove('text-green-500');
                stockStatus.classList.add('text-red-500');
                addToCartBtn.disabled = true;
                quantityInput.value = 0;
            }
        }
    }

    // Update quantity controls to respect size-specific stock limits
    decreaseQuantityBtn.addEventListener('click', () => {
        if (!selectedSizeName) {
            showNotification('Please select a size first', 'error');
            return;
        }
        let quantity = parseInt(quantityInput.value, 10);
        quantity = Math.max(1, quantity - 1);
        quantityInput.value = quantity;
    });

    increaseQuantityBtn.addEventListener('click', () => {
        if (!selectedSizeName) {
            showNotification('Please select a size first', 'error');
            return;
        }
        
        const selectedSizeData = currentSizes.find(size => size.name === selectedSizeName);
        if (selectedSizeData) {
            let quantity = parseInt(quantityInput.value, 10);
            quantity = Math.min(selectedSizeData.stock, quantity + 1);
            quantityInput.value = quantity;
            
            if (quantity === selectedSizeData.stock) {
                showNotification('Maximum available quantity reached', 'error');
            }
        }
    });

    // Update quantity input handler
    quantityInput.addEventListener('change', () => {
        if (!selectedSizeName) {
            showNotification('Please select a size first', 'error');
            quantityInput.value = 1;
            return;
        }
        
        const selectedSizeData = currentSizes.find(size => size.name === selectedSizeName);
        if (selectedSizeData) {
            let quantity = parseInt(quantityInput.value, 10);
            
            // Ensure quantity is within valid range
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
            } else if (quantity > selectedSizeData.stock) {
                quantity = selectedSizeData.stock;
                showNotification('Adjusted to maximum available quantity', 'error');
            }
            
            quantityInput.value = quantity;
        }
    });

    addToCartBtn.addEventListener('click', async function() {
        if (!selectedSizeName) {
            showNotification('Please select a size', 'error');
            return;
        }
    
        if (!selectedVariantId) {
            showNotification('Please select a variant', 'error');
            return;
        }
    
        const selectedSizeData = currentSizes.find(size => size.name === selectedSizeName);
        if (!selectedSizeData) {
            showNotification('Invalid size selected', 'error');
            return;
        }
    
        const quantity = parseInt(quantityInput.value, 10);
        if (isNaN(quantity) || quantity < 1 || quantity > selectedSizeData.stock) {
            showNotification('Invalid quantity', 'error');
            return;
        }
    
        try {
            const formData = new FormData();
            formData.append('variant_id', selectedVariantId);
            formData.append('quantity', quantity);
            formData.append('size_name', selectedSizeName);
    
            const response = await fetch('{% url "add_to_cart" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            });
    
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to add item to cart');
            }
    
            showNotification(data.message || 'Item added to cart successfully!', 'success');
    
            if (data.cart_count !== undefined) {
                updateCartCount(data.cart_count);
            }
    
        } catch (error) {
            console.error('Error:', error);
            showNotification(error.message || 'An error occurred. Please try again.', 'error');
        }
    });

    // Utility functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateCartCount(count) {
        const cartCountElement = document.querySelector('.cart-count');
        if (cartCountElement) {
            cartCountElement.textContent = count;
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.remove('bg-green-500', 'bg-red-500');
        notification.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
        notification.classList.remove('hidden');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }

    // Initialize zoom functionality
    initZoom();
});
</script>
<style>
    /* Size Button Styling */
    .size-button {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #333333;
        border-radius: 4px;
        transition: border-color 0.3s;
    }

    .size-button:hover {
        border-color: #555555;
    }

    .size-button:disabled {
        border-color: #666666;
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Stock Information Styling */
    .stock-info {
        font-size: 0.75rem; /* 12px */
        margin-top: 0.25rem; /* 4px */
    }

    .stock-info.in-stock {
        color: #22c55e; /* Green for in-stock */
    }

    .stock-info.out-of-stock {
        color: #ef4444; /* Red for out-of-stock */
    }
    .variant-image-button img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #zoom-container {
        position: relative;
        cursor: crosshair;
        overflow: visible !important;
    }
    
    #zoom-lens {
        position: absolute;
        border: 2px solid #ff6b00;
        background-color: rgba(255, 107, 0, 0.1);
        cursor: none;
        pointer-events: none;
        z-index: 10;
    }
    
    #zoom-result {
        position: absolute; /* Changed from fixed to absolute */
        left: calc(100% + 10px); /* Position right next to the image */
        top: 0;
        width: 400px;
        height: 400px;
        background-repeat: no-repeat;
        border: 2px solid #ff6b00;
        z-index: 1000;
        display: none;
        background-color: #222222;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    
    #main-image {
        cursor: crosshair;
    }
    
    .thumbnail-active {
        border: 2px solid #ff6b00;
    }
</style>
{% endblock %}
