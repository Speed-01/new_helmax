{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block scripts %}
<!-- Razorpay SDK -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
{% endblock %}

{% block content %}
<!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="min-h-screen bg-black text-white">
  <div class="max-w-7xl mx-auto px-4 py-12 md:px-6 lg:px-8">
    <!-- Checkout Header -->
    <div class="flex items-center mb-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-8 w-8 text-[#ff6b00]" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      <h1 class="text-3xl font-bold">Checkout</h1>
    </div>
    
    <!-- Checkout Progress -->
    <div class="mb-12">
      <div class="flex justify-between max-w-md">
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-[#ff6b00] text-black flex items-center justify-center mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <span class="text-sm">Cart</span>
        </div>
        <div class="flex-1 flex items-center">
          <div class="h-1 w-full bg-[#ff6b00]"></div>
        </div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-[#ff6b00] text-black flex items-center justify-center mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <span class="text-sm">Checkout</span>
        </div>
        <div class="flex-1 flex items-center">
          <div class="h-1 w-full bg-zinc-700"></div>
        </div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center mb-2">
            <span class="text-sm">3</span>
          </div>
          <span class="text-sm">Payment</span>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Delivery Address and Payment -->
      <div class="lg:col-span-2">
        <div class="mb-8">
          <!-- Tabs Header -->
          <div class="grid grid-cols-3 mb-6 bg-zinc-800 rounded-lg p-1">
            <button id="tab-delivery" onclick="switchTab('delivery')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors bg-[#ff6b00] text-black">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
              Delivery
            </button>
            <button id="tab-payment" onclick="switchTab('payment')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
              Payment
            </button>
            <button id="tab-review" onclick="switchTab('review')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Review
            </button>
          </div>
          
          <!-- Delivery Tab Content -->
          <div id="content-delivery" class="tab-content">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6 pb-3">
                <div class="flex justify-between items-center">
                  <h2 class="text-xl font-semibold">Delivery Address</h2>
                  <button 
                    onclick="toggleAddressForm()"
                    class="px-3 py-1.5 text-sm border border-[#ff6b00] text-[#ff6b00] rounded-md hover:bg-[#ff6b00]/10 flex items-center"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Add New Address
                  </button>
                </div>
                <p class="text-zinc-400 text-sm">Select where you want your items delivered</p>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  {% for address in user_addresses %}
                  <div class="flex">
                    <input 
                      type="radio" 
                      name="selected_address" 
                      id="address-{{ address.id }}"
                      value="{{ address.id }}"
                      class="mt-1 mr-4 text-[#ff6b00]"
                      {% if forloop.first %}checked{% endif %}
                    >
                    <div class="flex-1 bg-zinc-800 p-4 rounded-lg">
                      <div class="flex justify-between mb-2">
                        <div class="font-medium">{{ address.full_name }}</div>
                        <span class="text-xs px-2 py-1 bg-zinc-700 rounded-full">
                          {{ address.address_type }}
                        </span>
                      </div>
                      <div class="text-zinc-400 text-sm space-y-1">
                        <p>{{ address.address_line1 }}</p>
                        {% if address.address_line2 %}<p>{{ address.address_line2 }}</p>{% endif %}
                        <p>{{ address.city }}, {{ address.state }}, {{ address.pincode }}</p>
                        <p>Phone: {{ address.phone }}</p>
                      </div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="text-center py-8 text-zinc-400">
                    <p>No addresses found. Please add a new address.</p>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-end">
                <button 
                  onclick="switchTab('payment')"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Continue to Payment
                </button>
              </div>
            </div>
          </div>
          
          <!-- Payment Tab Content -->
          <div id="content-payment" class="tab-content hidden">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6">
                <h2 class="text-xl font-semibold">Payment Method</h2>
                <p class="text-zinc-400 text-sm">Select your preferred payment method</p>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  <div class="flex items-center space-x-4 bg-zinc-800 p-4 rounded-lg">
                    <input 
                      type="radio" 
                      name="payment_method" 
                      id="razorpay"
                      value="razorpay"
                      class="text-[#ff6b00]"
                      checked
                    >
                    <label for="razorpay" class="flex-1 cursor-pointer">
                      <div class="font-medium">Razorpay</div>
                      <div class="text-zinc-400 text-sm">Pay using Credit/Debit Card, UPI, or Net Banking</div>
                    </label>
                    <div class="flex space-x-2">
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">VISA</span>
                      </div>
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">MC</span>
                      </div>
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">UPI</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="flex items-center space-x-4 bg-zinc-800 p-4 rounded-lg">
                    <input 
                      type="radio" 
                      name="payment_method" 
                      id="cod"
                      value="cod"
                      class="text-[#ff6b00]"
                    >
                    <label for="cod" class="flex-1 cursor-pointer">
                      <div class="font-medium">Cash on Delivery</div>
                      <div class="text-zinc-400 text-sm">Pay when your order is delivered</div>
                      <div id="cod-warning" class="text-red-500 text-xs mt-1 hidden">Cash on Delivery not available for orders above â‚¹2,000</div>
                    </label>
                  </div>

                  <!-- Free Delivery Banner -->
                  <div class="mt-6 p-4 bg-zinc-800 rounded-lg">
                    <div class="flex justify-between items-center">
                      <div class="text-zinc-400 text-sm">
                        <p>Delivery</p>
                      </div>
                      <div class="font-medium text-[#ff6b00]">FREE</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-between">
                <button 
                  onclick="switchTab('delivery')"
                  class="px-4 py-2 border border-zinc-700 rounded-md hover:bg-zinc-800 transition-colors"
                >
                  Back
                </button>
                <button 
                  onclick="switchTab('review')"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Continue to Review
                </button>
              </div>
            </div>
          </div>
          
          <!-- Review Tab Content -->
          <div id="content-review" class="tab-content hidden">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6">
                <h2 class="text-xl font-semibold">Review Your Order</h2>
                <p class="text-zinc-400 text-sm">Please review your order details before placing</p>
              </div>
              <div class="p-6 space-y-6">
                <!-- Selected Address -->
                <div>
                  <h3 class="font-medium mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
                    Delivery Address
                  </h3>
                  <div class="bg-zinc-800 p-4 rounded-lg">
                    <div id="selected-address-details" class="text-sm">
                      <!-- This will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <!-- Selected Payment Method -->
                <div>
                  <h3 class="font-medium mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                    Payment Method
                  </h3>
                  <div class="bg-zinc-800 p-4 rounded-lg">
                    <p id="selected-payment-method" class="font-medium">
                      <!-- This will be populated by JavaScript -->
                    </p>
                  </div>
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-between">
                <button 
                  onclick="switchTab('payment')"
                  class="px-4 py-2 border border-zinc-700 rounded-md hover:bg-zinc-800 transition-colors"
                >
                  Back
                </button>
                <button 
                  id="place-order-btn"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Place Order
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column - Order Summary -->
      <div>
        <!-- Product Details -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg mb-6">
          <div class="p-6 pb-3">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
              <h2 class="text-xl font-semibold">Order Summary</h2>
            </div>
            <p class="text-zinc-400 text-sm">{{ cart_items|length }} items in your cart</p>
          </div>
          <div class="p-6 space-y-4">
            {% for item in cart_items %}
            <div class="flex space-x-4">
              <img 
                src="{{ item.variant.images.first.image.url }}" 
                alt="{{ item.variant.product.name }}"
                class="w-20 h-20 object-cover rounded-md bg-zinc-800"
              >
              <div class="flex-1">
                <h3 class="font-medium">{{ item.variant.product.name }}</h3>
                <p class="text-zinc-400 text-sm">Color: {{ item.variant.color }}</p>
                <p class="text-zinc-400 text-sm">Qty: {{ item.quantity }}</p>
              </div>
              <div class="text-right">
                <p class="font-medium">â‚¹{{ item.variant.final_price|floatformat:2 }}</p>
                <p class="text-zinc-400 text-sm">
                    Total: â‚¹{{ item.variant.final_price|multiply:item.quantity|floatformat:2 }}
                </p>
              </div>
            </div>
            {% endfor %}
            
            <div class="my-4 border-t border-zinc-800"></div>
            
            <!-- Coupon Section -->
            <div>
              <button 
                id="toggle-coupons-btn"
                class="flex items-center justify-between w-full text-left mb-4"
              >
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5 text-[#ff6b00]" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                  <span class="font-medium">Apply Coupon</span>
                </div>
                <svg id="coupon-chevron-down" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                <svg id="coupon-chevron-up" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
              </button>
              
              <div id="coupon-section" class="space-y-4 mb-4 hidden">
                <div class="mb-4">
                  <label for="coupon-code" class="block text-sm font-medium mb-2">Have a coupon code?</label>
                  <div class="flex gap-2">
                    <input 
                      type="text" 
                      id="coupon-code" 
                      name="coupon_code"
                      class="flex-1 bg-zinc-800 border border-zinc-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#ff6b00] focus:border-transparent"
                      placeholder="Enter coupon code"
                    >
                    <button 
                      type="button"
                      id="apply-coupon"
                      class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors flex items-center gap-2"
                    >
                      <span class="coupon-btn-text">Apply</span>
                      <div class="coupon-loading hidden">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </div>
                    </button>
                    <button 
                      type="button"
                      id="remove-coupon"
                      class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden"
                    >
                      Remove
                    </button>
                  </div>
                  <p id="coupon-message" class="mt-2 text-sm"></p>
                  <div id="applied-coupon-details" class="mt-3 p-3 bg-zinc-800 rounded-md hidden">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="font-medium" id="applied-coupon-code"></p>
                        <p class="text-sm text-zinc-400" id="applied-coupon-description"></p>
                      </div>
                      <div class="text-[#ff6b00] font-medium" id="applied-coupon-discount"></div>
                    </div>
                  </div>
                </div>
                <div class="space-y-3">
                  <h4 class="text-sm font-medium">Available Coupons</h4>
                  {% for coupon in coupons %}
                  <div class="bg-zinc-800 p-3 rounded-lg relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-[#ff6b00] text-black px-2 py-1 text-xs font-bold rounded-bl-lg">
                      {% if coupon.type == 'percentage' %}
                        {{ coupon.value }}% OFF
                      {% else %}
                        â‚¹{{ coupon.value }} OFF
                      {% endif %}
                    </div>
                    
                    <div class="font-mono text-base mb-1">{{ coupon.code }}</div>
                    
                    <div class="text-zinc-400 text-xs space-y-1">
                      <p>Min. Purchase: â‚¹{{ coupon.minimum_purchase }}</p>
                      <p>Valid till: {{ coupon.expiry_date|date:"d M Y" }}</p>
                    </div>
                    
                    <button 
                      onclick="applyCouponCode('{{ coupon.code }}')"
                      {% if not coupon.is_applicable %}disabled{% endif %}
                      class="mt-2 w-full py-1.5 px-3 rounded text-sm {% if coupon.is_applicable %}text-[#ff6b00] hover:bg-zinc-700{% else %}text-zinc-500 cursor-not-allowed{% endif %} transition-colors"
                    >
                      {% if coupon.is_applicable %}Apply Coupon{% else %}Not Applicable{% endif %}
                    </button>
                    
                    {% if not coupon.is_applicable %}
                    <p class="text-red-500 text-xs mt-1">
                      *Add more items worth â‚¹{{ coupon.amount_needed }} to use this coupon
                    </p>
                    {% endif %}
                  </div>
                  {% empty %}
                  <div class="text-center py-4 text-zinc-400">
                    No coupons available at the moment
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            
            <div class="my-4 border-t border-zinc-800"></div>
            
            <!-- Price Details -->
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-zinc-400">Subtotal</span>
                <span>â‚¹{{ subtotal }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Product Discount</span>
                <span class="text-green-500">-â‚¹{{ product_discount }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Coupon Discount</span>
                <span id="coupon-discount-value" class="text-green-500">-â‚¹{{ coupon_discount }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Delivery</span>
                <span class="text-[#ff6b00]">FREE</span>
              </div>
              <!-- Final amount display -->
              <div class="flex justify-between font-medium text-lg">
                <span>Total Amount</span>
                <span id="final-amount">â‚¹{{ final_price|floatformat:2 }}</span>
              </div>
            </div>
        
        <!-- Secure Checkout Notice -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4">
          <div class="flex items-center text-sm text-zinc-400">
            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <span>Secure checkout powered by Razorpay</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Address Form Modal -->
<div id="addressFormModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
<div class="bg-zinc-900 p-6 rounded-lg w-full max-w-md">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold">Add New Address</h2>
    <button 
      onclick="toggleAddressForm()"
      class="text-zinc-400 hover:text-white"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
  </div>
  
  <form id="addressForm" class="space-y-4">
    {% csrf_token %}
    <div class="grid grid-cols-2 gap-4">
      <div class="col-span-2">
        <label for="address_type" class="block text-sm font-medium mb-1">Address Type</label>
        <select 
          id="address_type"
          name="address_type"
          required
          class="w-full bg-zinc-800 rounded px-4 py-2 text-white focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
          <option value="">Select Address Type</option>
          <option value="HOME">Home</option>
          <option value="WORK">Work</option>
          <option value="OTHER">Other</option>
        </select>
      </div>
      
      <div class="col-span-2">
        <label for="full_name" class="block text-sm font-medium mb-1">Full Name</label>
        <input 
          type="text"
          id="full_name"
          name="full_name"
          required
          placeholder="Enter your full name" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="email" class="block text-sm font-medium mb-1">Email</label>
        <input 
          type="email"
          id="email"
          name="email"
          required
          placeholder="Enter your email" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="phone" class="block text-sm font-medium mb-1">Phone</label>
        <input 
          type="tel"
          id="phone"
          name="phone"
          required
          placeholder="Enter your phone number" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-2">
        <label for="address_line1" class="block text-sm font-medium mb-1">Address Line 1</label>
        <input 
          type="text"
          id="address_line1"
          name="address_line1"
          required
          placeholder="House/Flat number, Building name" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-2">
        <label for="address_line2" class="block text-sm font-medium mb-1">Address Line 2 (Optional)</label>
        <input 
          type="text"
          id="address_line2"
          name="address_line2"
          placeholder="Street name, Landmark" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="city" class="block text-sm font-medium mb-1">City</label>
        <input 
          type="text"
          id="city"
          name="city"
          required
          placeholder="City" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="state" class="block text-sm font-medium mb-1">State</label>
        <input 
          type="text"
          id="state"
          name="state"
          required
          placeholder="State" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="pincode" class="block text-sm font-medium mb-1">Pincode</label>
        <input 
          type="text"
          id="pincode"
          name="pincode"
          required
          placeholder="Pincode" 
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
      
      <div class="col-span-1">
        <label for="country" class="block text-sm font-medium mb-1">Country</label>
        <input 
          type="text"
          id="country"
          name="country"
          required
          placeholder="Country" 
          value="India"
          readonly
          class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
        >
      </div>
    </div>
    
    <div class="flex justify-end space-x-3 mt-6">
      <button 
        type="button"
        onclick="toggleAddressForm()"
        class="px-4 py-2 border border-zinc-700 rounded-md hover:bg-zinc-800 transition-colors"
      >
        Cancel
      </button>
      <button 
        type="submit"
        class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
      >
        Save Address
      </button>
    </div>
  </form>
</div>
</div>

<script>
// Function to show notification
function showNotification(message, type = 'success') {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  
  notification.className = `py-2 px-4 rounded-md text-sm flex items-center justify-between ${
    type === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
  }`;
  
  notification.innerHTML = `
    <div class="flex items-center">
      ${type === 'success' 
        ? '<svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' 
        : '<svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'}
      <span>${message}</span>
    </div>
    <button onclick="this.parentElement.remove()" class="ml-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  `;
  
  container.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// Function to switch between tabs
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active state from all tab buttons
  document.querySelectorAll('[id^="tab-"]').forEach(tab => {
    tab.classList.remove('bg-[#ff6b00]', 'text-black');
  });
  
  // Show the selected tab content
  const tabContent = document.getElementById(`content-${tabName}`);
  if (tabContent) {
    tabContent.classList.remove('hidden');
  }
  
  // Set active state on the selected tab button
  const tabButton = document.getElementById(`tab-${tabName}`);
  if (tabButton) {
    tabButton.classList.add('bg-[#ff6b00]', 'text-black');
  }
  
  // Special handling for review tab
  if (tabName === 'review') {
    if (typeof updateReviewTabContent === 'function') {
      updateReviewTabContent();
    }
  }
  
  // Only check COD availability if we're on the payment tab
  // This ensures all necessary elements are loaded
  if (tabName === 'payment' || tabName === 'review') {
    // Delay slightly to ensure DOM is updated
    setTimeout(() => {
      updateCODAvailability();
    }, 100);
  }
}

// Function to update the content in the review tab
function updateReviewTabContent() {
  // Update selected address
  const selectedAddressRadio = document.querySelector('input[name="selected_address"]:checked');
  const selectedAddressDetails = document.getElementById('selected-address-details');
  
  if (selectedAddressRadio) {
    const addressDiv = selectedAddressRadio.nextElementSibling;
    const name = addressDiv.querySelector('.font-medium').textContent;
    const addressType = addressDiv.querySelector('.text-xs').textContent.trim();
    const addressLines = Array.from(addressDiv.querySelectorAll('.text-zinc-400 p')).map(p => p.textContent.trim());
    
    selectedAddressDetails.innerHTML = `
      <div class="font-medium">${name}</div>
      <span class="text-xs px-2 py-1 bg-zinc-700 rounded-full inline-block mb-2">${addressType}</span>
      <div class="text-zinc-400">
        ${addressLines.map(line => `<p>${line}</p>`).join('')}
      </div>
    `;
  } else {
    selectedAddressDetails.textContent = 'No address selected';
  }
  
  // Update selected payment method
  const selectedPaymentRadio = document.querySelector('input[name="payment_method"]:checked');
  const selectedPaymentMethod = document.getElementById('selected-payment-method');
  
  if (selectedPaymentRadio) {
    if (selectedPaymentRadio.value === 'razorpay') {
      selectedPaymentMethod.textContent = 'Razorpay (Credit/Debit Card, UPI, Net Banking)';
    } else if (selectedPaymentRadio.value === 'cod') {
      selectedPaymentMethod.textContent = 'Cash on Delivery';
    }
  } else {
    selectedPaymentMethod.textContent = 'No payment method selected';
  }
}

// Function to toggle the address form modal
function toggleAddressForm() {
  const modal = document.getElementById('addressFormModal');
  
  if (modal.classList.contains('hidden')) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
  } else {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = ''; // Allow scrolling
  }
}

// Function to toggle the coupon section
document.getElementById('toggle-coupons-btn').addEventListener('click', function() {
  const couponSection = document.getElementById('coupon-section');
  const chevronDown = document.getElementById('coupon-chevron-down');
  const chevronUp = document.getElementById('coupon-chevron-up');
  
  if (couponSection.classList.contains('hidden')) {
    couponSection.classList.remove('hidden');
    chevronDown.classList.add('hidden');
    chevronUp.classList.remove('hidden');
  } else {
    couponSection.classList.add('hidden');
    chevronDown.classList.remove('hidden');
    chevronUp.classList.add('hidden');
  }
});

// Function to directly apply a coupon code from the available coupons list
function applyCouponCode(code) {
  // Apply the coupon directly using the API
  applyCouponDirectly(code);
}

// Function to apply a coupon directly through the API
async function applyCouponDirectly(code) {
  try {
    if (!code || code.trim() === '') {
      showNotification('Please enter a valid coupon code', 'error');
      return;
    }
    
    // Show notification
    showNotification(`Applying coupon: ${code}...`, 'success');
    
    // Update coupon message
    const couponMessage = document.getElementById('coupon-message');
    if (couponMessage) {
      couponMessage.textContent = 'Applying coupon...';
      couponMessage.className = 'mt-2 text-sm text-zinc-400';
    }
    
    // Make the API call
    const response = await fetch('/cart/apply-coupon/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ code: code })
    });
    
    const data = await response.json();
    
    // Handle the response
    if (data.success) {
      // Update the coupon input field
      const couponInput = document.getElementById('coupon-code');
      if (couponInput) {
        couponInput.value = code;
        couponInput.disabled = true;
      }
      
      // Show success message
      if (couponMessage) {
        couponMessage.textContent = 'Coupon applied successfully!';
        couponMessage.className = 'mt-2 text-sm text-green-500';
      }
      
      // Update coupon details
      updateAppliedCouponDetails(data);
      
      // Show/hide appropriate buttons
      const applyButton = document.getElementById('apply-coupon');
      const removeButton = document.getElementById('remove-coupon');
      if (applyButton && removeButton) {
        applyButton.classList.add('hidden');
        removeButton.classList.remove('hidden');
      }
      
      // Update price information
      updatePriceElements(
        data.subtotal,
        data.discount,
        data.delivery_charge,
        data.final_amount
      );
      
      // Success notification
      showNotification('Coupon applied successfully!', 'success');
    } else {
      // Show error message
      if (couponMessage) {
        couponMessage.textContent = data.message || 'Failed to apply coupon';
        couponMessage.className = 'mt-2 text-sm text-red-500';
      }
      
      // Error notification
      showNotification(data.message || 'Failed to apply coupon', 'error');
    }
  } catch (error) {
    console.error('Error applying coupon:', error);
    showNotification('Error applying coupon. Please try again.', 'error');
    
    // Update error message
    const couponMessage = document.getElementById('coupon-message');
    if (couponMessage) {
      couponMessage.textContent = 'An error occurred while applying the coupon';
      couponMessage.className = 'mt-2 text-sm text-red-500';
    }
  }
}

// Function to update applied coupon details
function updateAppliedCouponDetails(data) {
  // Safety check - if data is invalid, don't proceed
  if (!data || !data.success) {
    console.error('Cannot update coupon details with invalid data:', data);
    return;
  }
  
  const couponDetails = document.getElementById('applied-coupon-details');
  if (!couponDetails) return;
  
  // Update coupon details
  const codeElement = document.getElementById('applied-coupon-code');
  const descriptionElement = document.getElementById('applied-coupon-description');
  const discountElement = document.getElementById('applied-coupon-discount');
  
  if (codeElement && data.coupon && data.coupon.code) {
    codeElement.textContent = data.coupon.code.toUpperCase();
  } else if (codeElement) {
    // Fallback if coupon details are missing but we have a code
    const code = document.getElementById('coupon-code')?.value;
    if (code) {
      codeElement.textContent = code.toUpperCase();
    }
  }
  
  if (descriptionElement && data.coupon && data.coupon.description) {
    descriptionElement.textContent = data.coupon.description;
  } else if (descriptionElement) {
    descriptionElement.textContent = 'Discount applied';
  }
  
  if (discountElement && typeof data.discount === 'number') {
    discountElement.textContent = `-â‚¹${data.discount.toFixed(2)}`;
  } else if (discountElement) {
    discountElement.textContent = `-â‚¹${(0).toFixed(2)}`;
  }
  
  // Show the details box
  couponDetails.classList.remove('hidden');
}

// Function to check if COD is available based on order amount
function updateCODAvailability() {
  // Get the final amount from the text content if the value element doesn't exist
  let finalAmount = 0;
  
  // First try to get it from the hidden input value
  const finalAmountElement = document.getElementById('final-amount-value');
  if (finalAmountElement) {
    finalAmount = parseFloat(finalAmountElement.value) || 0;
  } else {
    // Fall back to getting it from the displayed text
    const finalAmountText = document.getElementById('final-amount');
    if (finalAmountText) {
      // Extract number from format like 'â‚¹1234.56'
      const match = finalAmountText.textContent.match(/[\d.]+/);
      if (match) {
        finalAmount = parseFloat(match[0]) || 0;
      }
    }
  }
  
  const codRadio = document.getElementById('cod');
  const codWarning = document.getElementById('cod-warning');
  
  // Only proceed if we have both COD elements
  if (!codRadio || !codWarning) {
    return;
  }
  
  if (finalAmount > 2000) {
    codRadio.disabled = true;
    codWarning.classList.remove('hidden');
    
    // If COD was selected, switch to Razorpay
    if (codRadio.checked) {
      const razorpayRadio = document.getElementById('razorpay');
      if (razorpayRadio) {
        razorpayRadio.checked = true;
      }
    }
  } else {
    codRadio.disabled = false;
    codWarning.classList.add('hidden');
  }
}

// Function to update all price elements
function updatePriceElements(subtotal, discount, delivery, final) {
  // Update subtotal
  const subtotalElement = document.getElementById('subtotal-amount');
  if (subtotalElement) {
    subtotalElement.textContent = `â‚¹${subtotal.toFixed(2)}`;
  }
  
  // Update coupon discount
  const discountElement = document.getElementById('coupon-discount-value');
  if (discountElement) {
    discountElement.textContent = `-â‚¹${discount.toFixed(2)}`;
  }
  
  // Update delivery charge
  const deliveryElement = document.getElementById('delivery-charge-value');
  if (deliveryElement) {
    deliveryElement.textContent = `â‚¹${delivery.toFixed(2)}`;
  }
  
  // Update final amount
  const finalElement = document.getElementById('final-amount');
  if (finalElement) {
    finalElement.textContent = `â‚¹${final.toFixed(2)}`;
  }
  
  const finalValueElement = document.getElementById('final-amount-value');
  if (finalValueElement) {
    finalValueElement.value = final.toFixed(2);
  }
  
  // Update any other price elements if needed
  updateCODAvailability();
}

// Function to fetch updated cart totals
async function fetchCartTotals() {
    try {
      const response = await fetch('/cart/get-totals/', {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      if (data.success) {
        updatePriceElements(
          data.subtotal,
          data.coupon_discount || 0,
          data.delivery_charge || 0,
          data.final_amount
        );
      }
    } catch (error) {
      console.error('Error fetching cart totals:', error);
    }
  }

// Set the first tab as active when document is loaded
document.addEventListener('DOMContentLoaded', function() {
  // All DOM-ready code is inside this listener
  switchTab('delivery');
  
  // Handle address form submission
  document.getElementById('addressForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/accounts/address/add/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Address added successfully');
        toggleAddressForm();
        // Reload the page to show the new address
        window.location.reload();
      } else {
        showNotification(data.message || 'Failed to add address', 'error');
      }
    })
    .catch(error => {
      showNotification('An error occurred', 'error');
      console.error('Error:', error);
    });
  });
  
  // Coupon handling
  let currentCoupon = null;

  // Initial load of cart totals
fetchCartTotals();

// Check if there's an active coupon on page load
async function checkExistingCoupon() {
  try {
    const response = await fetch('/cart/check-coupon/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    const data = await response.json();
    if (data.success && data.has_coupon) {
      // Update the UI with the existing coupon
      updateAppliedCouponDetails(data);
      
      // Update UI elements
      const removeCouponBtn = document.getElementById('remove-coupon');
      const applyBtn = document.getElementById('apply-coupon');
      const couponInput = document.getElementById('coupon-code');
      
      if (removeCouponBtn && applyBtn && couponInput) {
        // Show remove button and hide apply button
        removeCouponBtn.classList.remove('hidden');
        couponInput.disabled = true;
        couponInput.value = data.coupon_code;
        applyBtn.classList.add('hidden');
      }
      
      // Update the price elements with the current values
      updatePriceElements(
        data.subtotal,
        data.discount,
        data.delivery_charge,
        data.final_amount
      );
      
      // Expand the coupon section to show the applied coupon
      const couponSection = document.getElementById('coupon-section');
      const chevronDown = document.getElementById('coupon-chevron-down');
      const chevronUp = document.getElementById('coupon-chevron-up');
      
      if (couponSection && chevronDown && chevronUp) {
        couponSection.classList.remove('hidden');
        chevronDown.classList.add('hidden');
        chevronUp.classList.remove('hidden');
      }
    }
  } catch (error) {
    console.error('Error checking existing coupon:', error);
  }
}

// Check for existing coupon on page load
checkExistingCoupon();

document.getElementById('apply-coupon').addEventListener('click', async function() {
    const couponBtn = this;
    const couponCode = document.getElementById('coupon-code').value.trim();
    const couponMessage = document.getElementById('coupon-message');
    
    if (!couponCode) {
      couponMessage.textContent = 'Please enter a coupon code';
      couponMessage.className = 'mt-2 text-sm text-red-500';
      return;
    }
    
    // Show loading state
    couponBtn.disabled = true;
    couponBtn.querySelector('.coupon-btn-text').textContent = 'Applying...';
    couponBtn.querySelector('.coupon-loading').classList.remove('hidden');
    couponMessage.textContent = 'Checking coupon...';
    couponMessage.className = 'mt-2 text-sm text-zinc-400';
    
    try {
      // Apply the coupon using the applyCouponDirectly function
      await applyCouponDirectly(couponCode);
    } catch (error) {
      console.error('Error:', error);
      couponMessage.textContent = 'An error occurred while applying the coupon';
      couponMessage.className = 'mt-2 text-sm text-red-500';
    } finally {
      // Reset button state
      couponBtn.disabled = false;
      couponBtn.querySelector('.coupon-btn-text').textContent = 'Apply';
      couponBtn.querySelector('.coupon-loading').classList.add('hidden');
    }
  });

  // Remove coupon handler
  document.getElementById('remove-coupon').addEventListener('click', async function() {
    const removeCouponBtn = this;
    const couponMessage = document.getElementById('coupon-message');
    const couponDetails = document.getElementById('applied-coupon-details');
    const applyBtn = document.getElementById('apply-coupon');
    const couponInput = document.getElementById('coupon-code');
    
    // Disable button during operation
    removeCouponBtn.disabled = true;
    
    // Show notification
    showNotification('Removing coupon...', 'success');
    
    try {
      const response = await fetch('/cart/remove-coupon/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Reset UI
        if (couponInput) {
          couponInput.value = '';
          couponInput.disabled = false;
        }
        
        if (couponMessage) {
          couponMessage.textContent = 'Coupon removed successfully';
          couponMessage.className = 'mt-2 text-sm text-green-500';
        }
        
        if (couponDetails) {
          couponDetails.classList.add('hidden');
        }
        
        // Update price elements
        updatePriceElements(
          data.subtotal,
          0, // No discount
          data.delivery_charge,
          data.final_amount
        );
        
        // Toggle buttons
        if (applyBtn) {
          applyBtn.classList.remove('hidden');
        }
        
        if (removeCouponBtn) {
          removeCouponBtn.classList.add('hidden');
        }
        
        // Success notification
        showNotification('Coupon removed successfully', 'success');
        
        // Update COD availability
        updateCODAvailability();
      } else {
        // Show error message
        if (couponMessage) {
          couponMessage.textContent = data.message || 'Failed to remove coupon';
          couponMessage.className = 'mt-2 text-sm text-red-500';
        }
        
        // Error notification
        showNotification(data.message || 'Failed to remove coupon', 'error');
      }
    } catch (error) {
      console.error('Error removing coupon:', error);
      
      // Show error message
      if (couponMessage) {
        couponMessage.textContent = 'An error occurred while removing the coupon';
        couponMessage.className = 'mt-2 text-sm text-red-500';
      }
      
      // Error notification
      showNotification('Error removing coupon. Please try again.', 'error');
    } finally {
      // Re-enable the button
      removeCouponBtn.disabled = false;
    }
  });
  
  // Place order button
  document.getElementById('place-order-btn').addEventListener('click', function() {
    const selectedAddressId = document.querySelector('input[name="selected_address"]:checked')?.value;
    const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
    
    if (!selectedAddressId) {
      showNotification('Please select a delivery address', 'error');
      switchTab('delivery');
      return;
    }
    
    if (!selectedPaymentMethod) {
      showNotification('Please select a payment method', 'error');
      switchTab('payment');
      return;
    }
    
    // Create order data
    const orderData = {
      address_id: selectedAddressId,
      payment_method: selectedPaymentMethod
    };
    
    // Send order data to server
    fetch('/orders/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (selectedPaymentMethod === 'razorpay') {
          // Initialize Razorpay payment
          const options = {
            key: data.key_id,
            amount: data.amount,
            currency: data.currency,
            name: 'Your Shop Name',
            description: 'Order Payment',
            order_id: data.razorpay_order_id,
            handler: function(response) {
              // Handle successful payment
              // Send the payment verification data to the server
              fetch('/payment/success/' + data.order_id + '/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature
                })
              })
              .then(response => response.json())
              .then(data => {
                if (data.status === 'success') {
                  window.location.href = data.redirect_url;
                } else {
                  showNotification(data.message || 'Payment verification failed', 'error');
                  window.location.href = data.redirect_url;
                }
              })
              .catch(error => {
                console.error('Error:', error);
                window.location.href = '/my-orders/';
              });
            },
            prefill: {
              name: data.customer_name,
              email: data.customer_email,
              contact: data.customer_phone
            },
            theme: {
              color: '#ff6b00'
            }
          };
          
          const rzp = new Razorpay(options);
          rzp.open();
        } else {
          // For COD, redirect to order details page
          window.location.href = data.redirect_url;
        }
      } else {
        showNotification(data.message || 'Failed to create order', 'error');
      }
    })
    .catch(error => {
      showNotification('An error occurred', 'error');
      console.error('Error:', error);
    });
  });
});
</script>
{% endblock %}