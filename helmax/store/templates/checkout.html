{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="min-h-screen bg-black text-white">
  <div class="max-w-7xl mx-auto px-4 py-12 md:px-6 lg:px-8">
    <!-- Checkout Header -->
    <div class="flex items-center mb-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-8 w-8 text-[#ff6b00]" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      <h1 class="text-3xl font-bold">Checkout</h1>
    </div>
    
    <!-- Checkout Progress -->
    <div class="mb-12">
      <div class="flex justify-between max-w-md">
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-[#ff6b00] text-black flex items-center justify-center mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <span class="text-sm">Cart</span>
        </div>
        <div class="flex-1 flex items-center">
          <div class="h-1 w-full bg-[#ff6b00]"></div>
        </div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-[#ff6b00] text-black flex items-center justify-center mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <span class="text-sm">Checkout</span>
        </div>
        <div class="flex-1 flex items-center">
          <div class="h-1 w-full bg-zinc-700"></div>
        </div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center mb-2">
            <span class="text-sm">3</span>
          </div>
          <span class="text-sm">Payment</span>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Delivery Address and Payment -->
      <div class="lg:col-span-2">
        <div class="mb-8">
          <!-- Tabs Header -->
          <div class="grid grid-cols-3 mb-6 bg-zinc-800 rounded-lg p-1">
            <button id="tab-delivery" onclick="switchTab('delivery')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors bg-[#ff6b00] text-black">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
              Delivery
            </button>
            <button id="tab-payment" onclick="switchTab('payment')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
              Payment
            </button>
            <button id="tab-review" onclick="switchTab('review')" class="py-2 px-4 rounded-md flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Review
            </button>
          </div>
          
          <!-- Delivery Tab Content -->
          <div id="content-delivery" class="tab-content">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6 pb-3">
                <div class="flex justify-between items-center">
                  <h2 class="text-xl font-semibold">Delivery Address</h2>
                  <button 
                    onclick="toggleAddressForm()"
                    class="px-3 py-1.5 text-sm border border-[#ff6b00] text-[#ff6b00] rounded-md hover:bg-[#ff6b00]/10 flex items-center"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Add New Address
                  </button>
                </div>
                <p class="text-zinc-400 text-sm">Select where you want your items delivered</p>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  {% for address in user_addresses %}
                  <div class="flex">
                    <input 
                      type="radio" 
                      name="selected_address" 
                      id="address-{{ address.id }}"
                      value="{{ address.id }}"
                      class="mt-1 mr-4 text-[#ff6b00]"
                      {% if forloop.first %}checked{% endif %}
                    >
                    <div class="flex-1 bg-zinc-800 p-4 rounded-lg">
                      <div class="flex justify-between mb-2">
                        <div class="font-medium">{{ address.full_name }}</div>
                        <span class="text-xs px-2 py-1 bg-zinc-700 rounded-full">
                          {{ address.address_type }}
                        </span>
                      </div>
                      <div class="text-zinc-400 text-sm space-y-1">
                        <p>{{ address.address_line1 }}</p>
                        {% if address.address_line2 %}<p>{{ address.address_line2 }}</p>{% endif %}
                        <p>{{ address.city }}, {{ address.state }}, {{ address.pincode }}</p>
                        <p>Phone: {{ address.phone }}</p>
                      </div>
                    </div>
                  </div>
                  {% empty %}
                  <div class="text-center py-8 text-zinc-400">
                    <p>No addresses found. Please add a new address.</p>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-end">
                <button 
                  onclick="switchTab('payment')"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Continue to Payment
                </button>
              </div>
            </div>
          </div>
          
          <!-- Payment Tab Content -->
          <div id="content-payment" class="tab-content hidden">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6">
                <h2 class="text-xl font-semibold">Payment Method</h2>
                <p class="text-zinc-400 text-sm">Select your preferred payment method</p>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  <div class="flex items-center space-x-4 bg-zinc-800 p-4 rounded-lg">
                    <input 
                      type="radio" 
                      name="payment_method" 
                      id="razorpay"
                      value="razorpay"
                      class="text-[#ff6b00]"
                      checked
                    >
                    <label for="razorpay" class="flex-1 cursor-pointer">
                      <div class="font-medium">Razorpay</div>
                      <div class="text-zinc-400 text-sm">Pay using Credit/Debit Card, UPI, or Net Banking</div>
                    </label>
                    <div class="flex space-x-2">
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">VISA</span>
                      </div>
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">MC</span>
                      </div>
                      <div class="w-10 h-6 bg-white rounded flex items-center justify-center">
                        <span class="text-black text-xs font-bold">UPI</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="flex items-center space-x-4 bg-zinc-800 p-4 rounded-lg">
                    <input 
                      type="radio" 
                      name="payment_method" 
                      id="cod"
                      value="cod"
                      class="text-[#ff6b00]"
                    >
                    <label for="cod" class="flex-1 cursor-pointer">
                      <div class="font-medium">Cash on Delivery</div>
                      <div class="text-zinc-400 text-sm">Pay when your order is delivered</div>
                      <div id="cod-warning" class="text-red-500 text-xs mt-1 hidden">Cash on Delivery not available for orders above ₹2,000</div>
                    </label>
                  </div>

                  <!-- Delivery Charge Section -->
                  <div class="mt-6 p-4 bg-zinc-800 rounded-lg">
                    <h3 class="font-medium mb-2">Delivery Charges</h3>
                    <div class="flex justify-between items-center">
                      <div class="text-zinc-400 text-sm">
                        <p>Delivery to selected address</p>
                        <p id="selected-location" class="text-xs mt-1"></p>
                      </div>
                      <div id="delivery-charge" class="font-medium">₹0.00</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-between">
                <button 
                  onclick="switchTab('delivery')"
                  class="px-4 py-2 border border-zinc-700 rounded-md hover:bg-zinc-800 transition-colors"
                >
                  Back
                </button>
                <button 
                  onclick="switchTab('review')"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Continue to Review
                </button>
              </div>
            </div>
          </div>
          
          <!-- Review Tab Content -->
          <div id="content-review" class="tab-content hidden">
            <div class="bg-zinc-900 border border-zinc-800 rounded-lg">
              <div class="p-6">
                <h2 class="text-xl font-semibold">Review Your Order</h2>
                <p class="text-zinc-400 text-sm">Please review your order details before placing</p>
              </div>
              <div class="p-6 space-y-6">
                <!-- Selected Address -->
                <div>
                  <h3 class="font-medium mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
                    Delivery Address
                  </h3>
                  <div class="bg-zinc-800 p-4 rounded-lg">
                    <div id="selected-address-details" class="text-sm">
                      <!-- This will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <!-- Selected Payment Method -->
                <div>
                  <h3 class="font-medium mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                    Payment Method
                  </h3>
                  <div class="bg-zinc-800 p-4 rounded-lg">
                    <p id="selected-payment-method" class="font-medium">
                      <!-- This will be populated by JavaScript -->
                    </p>
                  </div>
                </div>
              </div>
              <div class="p-6 border-t border-zinc-800 flex justify-between">
                <button 
                  onclick="switchTab('payment')"
                  class="px-4 py-2 border border-zinc-700 rounded-md hover:bg-zinc-800 transition-colors"
                >
                  Back
                </button>
                <button 
                  id="place-order-btn"
                  class="px-4 py-2 bg-[#ff6b00] text-black rounded-md hover:bg-[#ff6b00]/90 transition-colors"
                >
                  Place Order
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column - Order Summary -->
      <div>
        <!-- Product Details -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg mb-6">
          <div class="p-6 pb-3">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
              <h2 class="text-xl font-semibold">Order Summary</h2>
            </div>
            <p class="text-zinc-400 text-sm">{{ cart_items|length }} items in your cart</p>
          </div>
          <div class="p-6 space-y-4">
            {% for item in cart_items %}
            <div class="flex space-x-4">
              <img 
                src="{{ item.variant.images.first.image.url }}" 
                alt="{{ item.variant.product.name }}"
                class="w-20 h-20 object-cover rounded-md bg-zinc-800"
              >
              <div class="flex-1">
                <h3 class="font-medium">{{ item.variant.product.name }}</h3>
                <p class="text-zinc-400 text-sm">Color: {{ item.variant.color }}</p>
                <p class="text-zinc-400 text-sm">Qty: {{ item.quantity }}</p>
              </div>
              <div class="text-right">
                <p class="font-medium">₹{{ item.variant.final_price|floatformat:2 }}</p>
                <p class="text-zinc-400 text-sm">
                    Total: ₹{{ item.variant.final_price|multiply:item.quantity|floatformat:2 }}
                </p>
              </div>
            </div>
            {% endfor %}
            
            <div class="my-4 border-t border-zinc-800"></div>
            
            <!-- Coupon Section -->
            <div>
              <button 
                id="toggle-coupons-btn"
                class="flex items-center justify-between w-full text-left mb-4"
              >
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5 text-[#ff6b00]" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                  <span class="font-medium">Apply Coupon</span>
                </div>
                <svg id="coupon-chevron-down" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                <svg id="coupon-chevron-up" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
              </button>
              
              <div id="coupon-section" class="space-y-4 mb-4 hidden">
                <div class="flex gap-2">
                  <input 
                    type="text" 
                    id="coupon-code"
                    placeholder="Enter coupon code" 
                    class="flex-1 bg-zinc-800 border border-zinc-700 rounded px-4 py-2 focus:outline-none focus:border-[#ff6b00]"
                  >
                  <button 
                    id="apply-coupon-btn"
                    class="bg-[#ff6b00] hover:bg-[#ff6b00]/90 px-4 py-2 rounded text-black transition-colors"
                  >
                    Apply
                  </button>
                </div>
                
                <div id="coupon-message" class="text-sm"></div>
                
                <div class="space-y-3">
                  <h4 class="text-sm font-medium">Available Coupons</h4>
                  {% for coupon in coupons %}
                  <div class="bg-zinc-800 p-3 rounded-lg relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-[#ff6b00] text-black px-2 py-1 text-xs font-bold rounded-bl-lg">
                      {% if coupon.type == 'percentage' %}
                        {{ coupon.value }}% OFF
                      {% else %}
                        ₹{{ coupon.value }} OFF
                      {% endif %}
                    </div>
                    
                    <div class="font-mono text-base mb-1">{{ coupon.code }}</div>
                    
                    <div class="text-zinc-400 text-xs space-y-1">
                      <p>Min. Purchase: ₹{{ coupon.minimum_purchase }}</p>
                      <p>Valid till: {{ coupon.expiry_date|date:"d M Y" }}</p>
                    </div>
                    
                    <button 
                      onclick="applyCouponCode('{{ coupon.code }}')"
                      {% if not coupon.is_applicable %}disabled{% endif %}
                      class="mt-2 w-full py-1.5 px-3 rounded text-sm {% if coupon.is_applicable %}text-[#ff6b00] hover:bg-zinc-700{% else %}text-zinc-500 cursor-not-allowed{% endif %} transition-colors"
                    >
                      {% if coupon.is_applicable %}Apply Coupon{% else %}Not Applicable{% endif %}
                    </button>
                    
                    {% if not coupon.is_applicable %}
                    <p class="text-red-500 text-xs mt-1">
                      *Add more items worth ₹{{ coupon.amount_needed }} to use this coupon
                    </p>
                    {% endif %}
                  </div>
                  {% empty %}
                  <div class="text-center py-4 text-zinc-400">
                    No coupons available at the moment
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            
            <div class="my-4 border-t border-zinc-800"></div>
            
            <!-- Price Details -->
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-zinc-400">Subtotal</span>
                <span>₹{{ subtotal }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Product Discount</span>
                <span class="text-green-500">-₹{{ product_discount }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Coupon Discount</span>
                <span id="coupon-discount" class="text-green-500">-₹{{ coupon_discount }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Delivery Charges</span>
                <span id="delivery-charge">₹0.00</span>
              </div>
              <div class="my-4 border-t border-zinc-800"></div>
              <div class="flex justify-between font-medium text-lg">
                <span>Total Amount</span>
                <span id="final-amount">₹{{ final_price|floatformat:2 }}</span>
              </div>
              <!-- Hidden field to keep track of final price without delivery -->
              <input type="hidden" id="final-amount-value" value="{{ final_price|floatformat:2 }}">
            </div>
        
        <!-- Secure Checkout Notice -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4">
          <div class="flex items-center text-sm text-zinc-400">
            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <span>Secure checkout powered by Razorpay</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Address Form Modal -->
<div id="addressFormModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
  <div class="bg-zinc-900 p-6 rounded-lg w-full max-w-md">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold">Add New Address</h2>
      <button 
        onclick="toggleAddressForm()"
        class="text-zinc-400 hover:text-white"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    
    <form id="addressForm" class="space-y-4">
      {% csrf_token %}
      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2">
          <label for="address_type" class="block text-sm font-medium mb-1">Address Type</label>
          <select 
            id="address_type"
            name="address_type"
            required
            class="w-full bg-zinc-800 rounded px-4 py-2 text-white focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
            <option value="">Select Address Type</option>
            <option value="HOME">Home</option>
            <option value="WORK">Work</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        
        <div class="col-span-2">
          <label for="full_name" class="block text-sm font-medium mb-1">Full Name</label>
          <input 
            type="text"
            id="full_name"
            name="full_name"
            required
            placeholder="Enter your full name" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-1">
          <label for="email" class="block text-sm font-medium mb-1">Email</label>
          <input 
            type="email"
            id="email"
            name="email"
            required
            placeholder="Enter your email" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-1">
          <label for="phone" class="block text-sm font-medium mb-1">Phone</label>
          <input 
            type="tel"
            id="phone"
            name="phone"
            required
            placeholder="Enter your phone number" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-2">
          <label for="address_line1" class="block text-sm font-medium mb-1">Address Line 1</label>
          <input 
            type="text"
            id="address_line1"
            name="address_line1"
            required
            placeholder="House/Flat number, Building name" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-2">
          <label for="address_line2" class="block text-sm font-medium mb-1">Address Line 2 (Optional)</label>
          <input 
            type="text"
            id="address_line2"
            name="address_line2"
            placeholder="Street name, Landmark" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-1">
          <label for="pincode" class="block text-sm font-medium mb-1">Pincode</label>
          <input 
            type="text"
            id="pincode"
            name="pincode"
            required
            placeholder="Enter pincode" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-1">
          <label for="city" class="block text-sm font-medium mb-1">City</label>
          <input 
            type="text"
            id="city"
            name="city"
            required
            placeholder="Enter city" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-2">
          <label for="state" class="block text-sm font-medium mb-1">State</label>
          <input 
            type="text"
            id="state"
            name="state"
            required
            placeholder="Enter state" 
            class="w-full bg-zinc-800 border border-zinc-700 rounded px-4 py-2 text-white placeholder-zinc-400 focus:ring-[#ff6b00] focus:border-[#ff6b00]"
          >
        </div>
        
        <div class="col-span-2 flex items-center space-x-2">
          <input 
            type="checkbox" 
            id="is_default"
            name="is_default"
            class="rounded bg-zinc-800 text-[#ff6b00] focus:ring-[#ff6b00]"
          >
          <label for="is_default">Set as Default Address</label>
        </div>
      </div>
      
      <button 
        type="submit" 
        class="w-full bg-[#ff6b00] text-black hover:bg-[#ff6b00]/90 py-2 rounded-lg transition-colors mt-4"
      >
        Save Address
      </button>
    </form>
  </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="django-data" 
     data-razorpay-key="{{ razorpay_key_id }}"
     data-user-name="{{ request.user.username }}"
     data-user-email="{{ request.user.email }}"
     data-user-phone="{{ request.user.phone|default:'' }}"
     data-place-order-url="{% url 'place_order' %}"
     data-validate-cart-url="{% url 'validate_cart' %}"
     data-view-cart-url="{% url 'view_cart' %}"
     data-manage-address-url="{% url 'userManageAddress' %}"
     data-get-delivery-charge-url="{{ get_delivery_charge_url }}"
     data-subtotal="{{ subtotal }}"
     style="display: none;">
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// Get data from Django
const djangoData = document.getElementById('django-data');
const razorpayKey = djangoData.dataset.razorpayKey || djangoData.getAttribute('data-razorpay-key');
const userName = djangoData.dataset.userName;
const userEmail = djangoData.dataset.userEmail;
const userPhone = djangoData.dataset.userPhone;
const placeOrderUrl = djangoData.dataset.placeOrderUrl;
const validateCartUrl = djangoData.dataset.validateCartUrl;
const viewCartUrl = djangoData.dataset.viewCartUrl;
const manageAddressUrl = djangoData.dataset.manageAddressUrl;
const getDeliveryChargeUrl = djangoData.dataset.getDeliveryChargeUrl;

// Initialize variables
let selectedAddressId = document.querySelector('input[name="selected_address"]:checked')?.value;
let selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
let currentSubtotal = parseFloat(djangoData.dataset.subtotal || 0);
let deliveryCharge = 0;

// Function to update COD visibility based on total amount
function updateCODVisibility() {
    const codOption = document.getElementById('cod').parentElement.parentElement;
    const codWarning = document.getElementById('cod-warning');
    const totalAmount = currentSubtotal + deliveryCharge;
    
    if (totalAmount > 2000) {
        codOption.style.display = 'none';
        document.getElementById('razorpay').checked = true;
        codWarning.style.display = 'block';
    } else {
        codOption.style.display = 'flex';
        codWarning.style.display = 'none';
    }
}

// Function to fetch and update delivery charge
async function updateDeliveryCharge() {
    if (!selectedAddressId) return;
    
    try {
        const response = await fetch(`${getDeliveryChargeUrl}${selectedAddressId}/`);
        if (!response.ok) throw new Error('Failed to fetch delivery charge');
        
        const data = await response.json();
        deliveryCharge = parseFloat(data.charge);
        
        // Update delivery charge display
        document.getElementById('delivery-charge').textContent = `₹${deliveryCharge.toFixed(2)}`;
        
        // Update selected location display
        const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
        if (selectedAddress) {
            const addressDetails = selectedAddress.closest('.flex').querySelector('.text-zinc-400').textContent;
            document.getElementById('selected-location').textContent = addressDetails;
        }
        
        // Update COD visibility
        updateCODVisibility();
    } catch (error) {
        console.error('Error fetching delivery charge:', error);
        showNotification('error', 'Failed to calculate delivery charge');
    }
}

// Add event listeners
document.querySelectorAll('input[name="selected_address"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        selectedAddressId = e.target.value;
        updateDeliveryCharge();
    });
});

// Initialize on page load
window.addEventListener('load', () => {
    updateDeliveryCharge();
    updateCODVisibility();
});

// Tab switching functionality
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Show selected tab content
  document.getElementById(`content-${tabName}`).classList.remove('hidden');
  
  // Update tab buttons
  document.querySelectorAll('[id^="tab-"]').forEach(tab => {
    tab.classList.remove('bg-[#ff6b00]', 'text-black');
  });
  document.getElementById(`tab-${tabName}`).classList.add('bg-[#ff6b00]', 'text-black');
  
  // Update review tab with selected address and payment method
  if (tabName === 'review') {
    updateReviewTab();
  }

  // Calculate delivery charge when switching to payment tab
  if (tabName === 'payment') {
    calculateDeliveryCharge();
    updateCODAvailability();
  }
}

// Calculate delivery charge based on selected address
function calculateDeliveryCharge() {
  const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
  if (!selectedAddress) {
    showNotification('Please select a delivery address first', 'error');
    return;
  }

  const addressId = selectedAddress.value;
  const addressDetails = selectedAddress.nextElementSibling.querySelector('.text-zinc-400');
  const cityState = addressDetails ? addressDetails.textContent.match(/([^,]+),\s*([^,]+),/) : null;
  
  // Show loading state
  document.getElementById('delivery-charge').textContent = 'Calculating...';
  document.getElementById('selected-location').textContent = cityState ? `${cityState[1]}, ${cityState[2]}` : '';
  
  fetch('/api/get-delivery-charge/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ 
      address_id: addressId,
      city: cityState ? cityState[1].trim() : '',
      state: cityState ? cityState[2].trim() : ''
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update delivery charge
      deliveryCharge = parseFloat(data.charge) || 0;
      document.getElementById('delivery-charge').textContent = `₹${deliveryCharge.toFixed(2)}`;
      
      // Update final amount
      updateTotalAmount();
      
      // Check if COD is available based on final amount
      updateCODAvailability();
      
    } else {
      document.getElementById('delivery-charge').textContent = '₹0.00';
      showNotification(data.message || 'Error calculating delivery charge', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('delivery-charge').textContent = '₹0.00';
    showNotification('Failed to calculate delivery charge', 'error');
  });
}

// Update the total amount including delivery charge
function updateTotalAmount() {
  const finalPrice = parseFloat(document.getElementById('final-amount-value').value);
  const totalWithDelivery = finalPrice + deliveryCharge;
  document.getElementById('final-amount').innerHTML = `₹${totalWithDelivery.toFixed(2)}`;
  
  // Check COD availability after updating total
  const codOption = document.getElementById('cod');
  const codWarning = document.getElementById('cod-warning');
  
  if (totalWithDelivery > 2000) {
    // Disable COD for orders above ₹2000
    codOption.disabled = true;
    codOption.checked = false;
    codWarning.classList.remove('hidden');
    
    // Switch to Razorpay if COD was selected
    if (document.querySelector('input[name="payment_method"]:checked')?.value === 'cod') {
      document.getElementById('razorpay').checked = true;
    }
  } else {
    // Enable COD for orders below ₹2000
    codOption.disabled = false;
    codWarning.classList.add('hidden');
  }
}

// Check if COD is available based on total amount
function updateCODAvailability() {
  const finalPrice = document.getElementById('final-amount-value').value;
  const totalWithDelivery = parseFloat(finalPrice) + deliveryCharge;
  const codOption = document.getElementById('cod');
  const codLabel = document.querySelector('label[for="cod"]');
  const codWarning = document.getElementById('cod-warning');
  
  if (totalWithDelivery > 2000) {
    // Disable COD
    codOption.disabled = true;
    codOption.checked = false;
    codLabel.classList.add('opacity-50');
    
    // If COD was selected, switch to Razorpay
    if (selectedPaymentMethod === 'cod') {
      document.getElementById('razorpay').checked = true;
      selectedPaymentMethod = 'razorpay';
    }
    
    // Show warning
    if (!codWarning) {
      const warningDiv = document.createElement('div');
      warningDiv.id = 'cod-warning';
      warningDiv.className = 'text-red-500 text-xs mt-1';
      warningDiv.textContent = 'Cash on Delivery not available for orders above ₹2,000';
      codLabel.parentNode.appendChild(warningDiv);
    }
  } else {
    // Enable COD
    codOption.disabled = false;
    codLabel.classList.remove('opacity-50');
    
    // Remove warning
    if (codWarning) {
      codWarning.remove();
    }
  }
}

// Update review tab with selected data
function updateReviewTab() {
  // Update selected address details
  const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
  if (selectedAddress) {
    const addressBlock = selectedAddress.nextElementSibling;
    const addressDetails = document.getElementById('selected-address-details');
    addressDetails.innerHTML = addressBlock.innerHTML;
  }
  
  // Update selected payment method
  const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
  if (paymentMethod) {
    const paymentMethodText = paymentMethod.value === 'razorpay' 
      ? 'Razorpay (Cards/UPI/Netbanking)' 
      : 'Cash on Delivery';
    document.getElementById('selected-payment-method').textContent = paymentMethodText;
  }
}

// Toggle address form modal
function toggleAddressForm() {
  const modal = document.getElementById('addressFormModal');
  if (modal.classList.contains('hidden')) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  } else {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

// Toggle coupon section
document.getElementById('toggle-coupons-btn').addEventListener('click', function() {
  const couponSection = document.getElementById('coupon-section');
  const chevronDown = document.getElementById('coupon-chevron-down');
  const chevronUp = document.getElementById('coupon-chevron-up');
  
  if (couponSection.classList.contains('hidden')) {
    couponSection.classList.remove('hidden');
    chevronDown.classList.add('hidden');
    chevronUp.classList.remove('hidden');
  } else {
    couponSection.classList.add('hidden');
    chevronDown.classList.remove('hidden');
    chevronUp.classList.add('hidden');
  }
});

// Apply coupon code from available coupons
function applyCouponCode(code) {
  document.getElementById('coupon-code').value = code;
  applyCoupon();
}

// Apply coupon
function applyCoupon() {
  const code = document.getElementById('coupon-code').value;
  const messageDiv = document.getElementById('coupon-message');
  
  fetch('/apply-coupon/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ coupon_code: code })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      messageDiv.innerHTML = `Coupon applied! Discount: ₹${data.discount}`;
      messageDiv.className = "mt-2 text-sm text-green-500";
      document.getElementById('coupon-discount').innerHTML = `-₹${data.discount}`;
      
      // Update final price without delivery
      document.getElementById('final-amount-value').value = data.final_amount;
      
      // Update final price with delivery
      updateTotalAmount();
      
      // Check if COD is still available with new total
      updateCODAvailability();
      
      // Close the coupons section after successful application
      document.getElementById('coupon-section').classList.add('hidden');
      document.getElementById('coupon-chevron-down').classList.remove('hidden');
      document.getElementById('coupon-chevron-up').classList.add('hidden');
    } else {
      messageDiv.innerHTML = data.message;
      messageDiv.className = "mt-2 text-sm text-red-500";
    }
  })
  .catch(error => {
    messageDiv.innerHTML = 'Error applying coupon';
    messageDiv.className = "mt-2 text-sm text-red-500";
  });
}

// Handle address form submission
document.getElementById('addressForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  try {
    const response = await fetch(manageAddressUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    });

    if (response.ok) {
      const data = await response.json();
      showNotification('Address added successfully!', 'success');
      toggleAddressForm();
      location.reload();
    } else {
      throw new Error('Failed to add address');
    }
  } catch (error) {
    console.error('Error:', error);
    showNotification('Failed to add address. Please try again.', 'error');
  }
});

// Handle address selection
document.querySelectorAll('input[name="selected_address"]').forEach(radio => {
  radio.addEventListener('change', function() {
    selectedAddressId = this.value;
    // Recalculate delivery charge when address changes
    calculateDeliveryCharge();
  });
});

// Handle payment method selection
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
  radio.addEventListener('change', function() {
    selectedPaymentMethod = this.value;
  });
});

// Place order button
document.getElementById('place-order-btn').addEventListener('click', placeOrder);

function placeOrder() {
  if (!selectedAddressId) {
    showNotification('Please select a delivery address', 'error');
    return;
  }

  const formData = new FormData();
  formData.append('address_id', selectedAddressId);
  formData.append('payment_method', selectedPaymentMethod);
  formData.append('delivery_charge', deliveryCharge);
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

  fetch(placeOrderUrl, {
    method: 'POST',
    body: formData,
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('Response data:', data);

    if (data.success) {
      if (selectedPaymentMethod === 'razorpay') {
        // Initialize Razorpay
        initializeRazorpay(data.razorpay_order_id, data.amount);
      } else {
        // COD or other payment methods
        window.location.href = data.redirect_url;
      }
    } else {
      showNotification(data.message || 'Error placing order', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error placing order. Please try again.', 'error');
  });
}

function initializeRazorpay(orderId, amount) {
  const options = {
    "key": razorpayKey, 
    "amount": amount,
    "currency": "INR",
    "name": "Helmax",
    "description": "Order Payment",
    "order_id": orderId,
    "handler": function (response) {
      verifyPayment(response);
    },
    "prefill": {
      "name": userName,
      "email": userEmail,
      "contact": userPhone
    },
    "theme": {
      "color": "#ff6b00"
    }
  };
  const rzp1 = new Razorpay(options);
  rzp1.open();
}

function verifyPayment(response) {
  fetch('/payment/success/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      razorpay_payment_id: response.razorpay_payment_id,
      razorpay_order_id: response.razorpay_order_id,
      razorpay_signature: response.razorpay_signature
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      window.location.href = data.redirect_url;
    } else {
      showNotification(data.message || 'Payment verification failed', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Payment verification failed', 'error');
  });
}

// Validate cart every 10 seconds
setInterval(validateCart, 10000);

function validateCart() {
  fetch('/validate-cart/', {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (!data.is_valid) {
      showNotification(data.errors.join('\n'), 'error');
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Error validating cart:', error);
    showNotification('Failed to validate cart. Please refresh the page.', 'error');
  });
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Show notification
function showNotification(message, type = 'success') {
  // Create notification container if it doesn't exist
  let notificationContainer = document.getElementById('notification-container');
  if (!notificationContainer) {
    notificationContainer = document.createElement('div');
    notificationContainer.id = 'notification-container';
    notificationContainer.className = 'fixed top-4 right-4 z-50 space-y-2';
    document.body.appendChild(notificationContainer);
  }

  // Create new notification
  const notification = document.createElement('div');
  notification.className = `transform transition-all duration-300 ease-in-out
      ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500'}
      text-white px-6 py-3 rounded-lg shadow-lg flex items-center`;
  
  // Add icon based on type
  const icon = document.createElement('span');
  icon.className = 'mr-2';
  icon.innerHTML = type === 'success' ? '✓' : type === 'error' ? '✕' : '⚠';
  notification.appendChild(icon);

  // Add message
  const text = document.createElement('span');
  text.textContent = message;
  notification.appendChild(text);

  // Add to container
  notificationContainer.appendChild(notification);

  // Animate in
  notification.style.transform = 'translateX(100%)';
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);

  // Remove after delay
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    notification.style.opacity = '0';
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 5000);
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  // Set initial tab
  switchTab('delivery');
  
  // Store initial amounts
  currentSubtotal = parseFloat(document.getElementById('final-amount-value').value || 0);
  
  // Check if COD should be available
  updateCODAvailability();
});
</script>
{% endblock %}