{% extends 'base01.html' %}

{% block extra_head %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .image-preview-item {
        position: relative;
        cursor: pointer;
        border: 2px solid #2A2A2A;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .image-preview-item:hover {
        border-color: #666;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
    }
    
    .image-preview-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
    }
    
    .image-preview-item .crop-btn {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(168, 85, 247, 0.9);
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }
    
    .image-preview-item:hover .crop-btn {
        opacity: 1;
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .crop-modal {
        background: #1A1A1A;
        border: 2px solid #333;
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .crop-modal h3 {
        color: #fff;
        margin-bottom: 16px;
        font-size: 18px;
    }
    
    .crop-container {
        position: relative;
        max-height: 400px;
        overflow: hidden;
        margin-bottom: 16px;
    }
    
    .crop-container img {
        max-width: 100%;
        max-height: 400px;
    }
    
    .crop-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .crop-actions button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .crop-actions .btn-save {
        background: linear-gradient(to right, #a855f7, #ec4899);
        color: white;
        font-weight: 600;
    }
    
    .crop-actions .btn-save:hover {
        opacity: 0.9;
    }
    
    .crop-actions .btn-cancel {
        background: #2A2A2A;
        color: #999;
    }
    
    .crop-actions .btn-cancel:hover {
        background: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6 bg-[#0A0A0A] text-gray-200">
    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-6">
        Add New Variant for {{ product.name }}
    </h1>

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="p-4 {% if message.tags == 'success' %}bg-green-500{% else %}bg-red-500{% endif %} text-white rounded-md">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form action="{% url 'addVariant' product.id %}" method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <div class="space-y-2">
            <label for="color" class="text-sm font-medium text-gray-300">Color</label>
            <input 
                type="text" 
                id="color" 
                name="color" 
                class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#2A2A2A] rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                required
            >
        </div>

        <div class="space-y-2">
            <label for="price" class="text-sm font-medium text-gray-300">Price</label>
            <input 
                type="number" 
                id="price" 
                name="price" 
                step="0.01" 
                class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#2A2A2A] rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                required
            >
        </div>


        <div class="space-y-2">
            <label class="text-sm font-medium text-gray-300">Sizes and Stock</label>
            <div class="space-y-3">
                {% for size_code, size_name in size_choices %}
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center min-w-[120px]">
                            <input type="checkbox" name="sizes" value="{{ size_code }}" class="form-checkbox text-purple-500">
                            <span class="ml-2">{{ size_name }}</span>
                        </label>
                        <div class="flex-1">
                            <input 
                                type="number" 
                                name="stock_{{ size_code }}" 
                                placeholder="Stock for {{ size_name }}"
                                class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#2A2A2A] rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                min="0"
                            >
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="space-y-2">
            <label for="images" class="text-sm font-medium text-gray-300">Images</label>
            <input 
                type="file" 
                id="images" 
                name="images" 
                multiple 
                accept="image/*" 
                class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#2A2A2A] rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            >
            <p class="text-xs text-gray-400 mt-2">Click on any image preview to crop it</p>
            <div id="imagePreviewContainer" class="image-preview-container"></div>
        </div>

        <!-- Hidden input to store cropped images -->
        <input type="hidden" id="croppedImages" name="cropped_images" value="">
        <input type="hidden" id="originalImages" name="original_images" value="">`

        <div class="flex justify-end space-x-4">
            <a 
                href="{% url 'adminProducts' %}" 
                class="px-4 py-2 bg-[#1A1A1A] border border-[#2A2A2A] rounded-md text-gray-200 hover:bg-[#2A2A2A] focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-colors duration-200"
            >
                Cancel
            </a>
            <button 
                type="submit" 
                class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-md hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all duration-200 transform hover:scale-105"
            >
                Add Variant
            </button>
        </div>
    </form>
    
    <!-- Image Crop Modal -->
    <div id="cropModal" class="modal-overlay">
        <div class="crop-modal">
            <h3>Crop Image</h3>
            <div class="crop-container">
                <img id="cropperImage" src="" alt="Image to crop">
            </div>
            <div class="crop-actions">
                <button type="button" class="btn-cancel" onclick="closeCropModal()">Cancel</button>
                <button type="button" class="btn-save" onclick="saveCroppedImage()">Save Crop</button>
            </div>
        </div>
    </div>
</div>

<!-- Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let imageFiles = [];
let croppedImagesData = {};
let currentCropIndex = null;
let cropper = null;

// Handle file input change
document.getElementById('images').addEventListener('change', function(e) {
    imageFiles = Array.from(this.files);
    displayImagePreviews();
});

function displayImagePreviews() {
    const container = document.getElementById('imagePreviewContainer');
    container.innerHTML = '';
    
    imageFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'image-preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index}">
                <div class="crop-btn" onclick="openCropModal(${index})">Crop</div>
            `;
            container.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}

function openCropModal(index) {
    currentCropIndex = index;
    const reader = new FileReader();
    reader.onload = function(e) {
        const imgElement = document.getElementById('cropperImage');
        imgElement.src = e.target.result;
        
        // Destroy previous cropper if exists
        if (cropper) {
            cropper.destroy();
        }
        
        // Initialize cropper
        cropper = new Cropper(imgElement, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            guides: true,
            center: true,
            highlight: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: true,
        });
    };
    reader.readAsDataURL(imageFiles[index]);
    
    document.getElementById('cropModal').classList.add('active');
}

function closeCropModal() {
    document.getElementById('cropModal').classList.remove('active');
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    currentCropIndex = null;
}

function saveCroppedImage() {
    if (!cropper || currentCropIndex === null) return;
    
    const canvas = cropper.getCroppedCanvas({
        maxWidth: 1024,
        maxHeight: 1024,
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });
    
    // Convert canvas to blob and store
    canvas.toBlob(function(blob) {
        croppedImagesData[currentCropIndex] = blob;
        
        // Update the preview to show cropped image
        const container = document.getElementById('imagePreviewContainer');
        const items = container.querySelectorAll('.image-preview-item');
        if (items[currentCropIndex]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                items[currentCropIndex].querySelector('img').src = e.target.result;
            };
            reader.readAsDataURL(blob);
        }
        
        closeCropModal();
    }, 'image/jpeg', 0.95);
}

// Override form submission to include cropped images
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    // Remove original file inputs to avoid duplicates
    const originalImages = formData.getAll('images');
    formData.delete('images');
    
    // Add cropped images if they exist, otherwise add original images
    Object.keys(croppedImagesData).forEach(index => {
        const blob = croppedImagesData[index];
        formData.append('images', blob, `cropped_${index}.jpg`);
    });
    
    // Add back original images that weren't cropped
    originalImages.forEach((file, index) => {
        if (!croppedImagesData.hasOwnProperty(index)) {
            formData.append('images', file);
        }
    });
    
    // Store info about which images were cropped
    formData.set('cropped_indices', Object.keys(croppedImagesData).join(','));
    
    // Submit via XMLHttpRequest for better NGINX compatibility
    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    
    xhr.onload = function() {
        if (xhr.status === 200 || xhr.status === 302) {
            window.location.href = '{% url "adminProducts" %}';
        } else {
            alert('Error adding variant. Please try again.');
            console.error('Error:', xhr.responseText);
        }
    };
    
    xhr.onerror = function() {
        alert('Network error. Please check your connection and try again.');
    };
    
    xhr.ontimeout = function() {
        alert('Request timeout. Please try with smaller images.');
    };
    
    // Set timeout to 5 minutes for large uploads
    xhr.timeout = 300000;
    
    xhr.send(formData);
});

// Close modal when clicking outside
document.getElementById('cropModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCropModal();
    }
});
</script>
{% endblock %}