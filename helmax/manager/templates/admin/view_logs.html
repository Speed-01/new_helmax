{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}View Logs - Helmax Admin{% endblock %}

{% block extrastyle %}
<style>
    .log-viewer {
        max-width: 100%;
        padding: 20px;
    }
    .log-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .log-stats {
        display: flex;
        gap: 20px;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    .stat-item {
        background: white;
        padding: 10px 15px;
        border-radius: 5px;
        border-left: 3px solid #417690;
    }
    .log-content {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-x: auto;
        max-height: 70vh;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .log-content .error {
        color: #f48771;
    }
    .log-content .warning {
        color: #dcdcaa;
    }
    .log-content .info {
        color: #4ec9b0;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary {
        background: #417690;
        color: white;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    select, input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="log-viewer">
    <h1>System Logs</h1>
    
    <div class="log-controls">
        <form method="get" action="{% url 'view_logs' %}">
            <div class="btn-group" style="align-items: center;">
                <label>
                    Log Type:
                    <select name="type" onchange="this.form.submit()">
                        {% for type in available_types %}
                        <option value="{{ type }}" {% if type == log_type %}selected{% endif %}>
                            {{ type|title }} Logs
                        </option>
                        {% endfor %}
                    </select>
                </label>
                
                <label>
                    Lines:
                    <input type="number" name="lines" value="{{ lines }}" min="10" max="10000" 
                           onchange="this.form.submit()" style="width: 100px;">
                </label>
                
                <button type="submit" class="btn btn-primary">Refresh</button>
                <a href="?type={{ log_type }}&lines={{ lines }}&download=true" class="btn btn-success">
                    Download
                </a>
                <button type="button" class="btn btn-danger" onclick="clearLog()">Clear Log</button>
            </div>
        </form>
    </div>
    
    <div class="log-stats">
        <div class="stat-item">
            <strong>File Size:</strong> {{ file_size }} KB
        </div>
        <div class="stat-item">
            <strong>Total Lines:</strong> {{ total_lines }}
        </div>
        <div class="stat-item">
            <strong>Showing:</strong> Last {{ lines }} lines
        </div>
        <div class="stat-item">
            <strong>Log Type:</strong> {{ log_type|title }}
        </div>
    </div>
    
    <div class="log-content" id="logContent">{{ log_content }}</div>
</div>

<script>
function clearLog() {
    if (!confirm('Are you sure you want to clear this log file? This action cannot be undone.')) {
        return;
    }
    
    fetch('{% url "clear_logs" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'type={{ log_type }}'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error clearing log: ' + error);
    });
}

// Syntax highlighting
document.addEventListener('DOMContentLoaded', function() {
    const logContent = document.getElementById('logContent');
    let html = logContent.innerHTML;
    
    // Highlight error lines
    html = html.replace(/(ERROR.*)/g, '<span class="error">$1</span>');
    html = html.replace(/(WARNING.*)/g, '<span class="warning">$1</span>');
    html = html.replace(/(INFO.*)/g, '<span class="info">$1</span>');
    
    logContent.innerHTML = html;
    
    // Auto-scroll to bottom
    logContent.scrollTop = logContent.scrollHeight;
});

// Auto-refresh every 30 seconds (optional)
// setInterval(function() {
//     location.reload();
// }, 30000);
</script>
{% endblock %}
