{% extends 'base01.html' %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-black py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-600 bg-clip-text text-transparent">
                Return Requests
            </h1>
            <p class="mt-2 text-sm text-gray-400">Manage and process customer return requests</p>
        </div>

        <!-- Main Card -->
        <div class="bg-[#0A0A0A] border border-[#222222] rounded-xl shadow-xl overflow-hidden">
            <div class="p-6 pb-3 border-b border-[#222222]">
                <h2 class="text-xl text-gray-200">Return Requests</h2>
                <p class="text-sm text-gray-400">View and manage all customer return requests in one place</p>
            </div>
            
            <div class="p-6">
                <!-- Search and Filter Section -->
                <div class="mb-6 space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input 
                                type="text" 
                                id="searchInput"
                                placeholder="Search by order ID or customer..." 
                                class="w-full pl-9 pr-4 py-2 rounded-md bg-[#111111] border border-[#222222] text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                            >
                        </div>
                        <div class="flex gap-2">
                            <div class="relative inline-block text-left" id="filterDropdown">
                                <button type="button" id="filterButton" class="inline-flex items-center px-4 py-2 bg-[#111111] border border-[#222222] rounded-md text-gray-200 hover:bg-opacity-80 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                    </svg>
                                    Filters
                                </button>
                                <div id="filterMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-[#111111] border border-[#222222] z-10">
                                    <div class="p-2">
                                        <p class="text-xs font-medium text-gray-400 mb-2">Status</p>
                                        <select id="statusFilter" class="w-full bg-[#0A0A0A] border border-[#222222] rounded-md p-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                            <option value="all">All Statuses</option>
                                            <option value="PENDING">Pending</option>
                                            <option value="APPROVED">Approved</option>
                                            <option value="REJECTED">Rejected</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Skeleton -->
                <div id="loadingSkeleton" class="rounded-md border border-[#222222] overflow-hidden">
                    <table class="min-w-full divide-y divide-[#222222]">
                        <thead class="bg-[#111111]">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Order ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                            </tr>
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                            </tr>
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full animate-pulse"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded animate-pulse"></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Desktop Table View -->
                <div id="desktopTableView" class="rounded-md border border-[#222222] overflow-hidden hidden md:block">
                    <table class="min-w-full divide-y divide-[#222222]">
                        <thead class="bg-[#111111]">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-[#1A1A1A]" data-sort="order_id">
                                    <div class="flex items-center">
                                        Order ID
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-[#1A1A1A]" data-sort="customer">
                                    <div class="flex items-center">
                                        Customer
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-[#1A1A1A]" data-sort="product">
                                    <div class="flex items-center">
                                        Product
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Reason
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-[#1A1A1A]" data-sort="status">
                                    <div class="flex items-center">
                                        Status
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="returnRequestsTableBody" class="bg-[#0A0A0A] divide-y divide-[#222222]">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div id="mobileCardView" class="md:hidden space-y-4">
                    <!-- Mobile cards will be populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden py-10 text-center text-gray-400">
                    No return requests found
                </div>

                <!-- Pagination -->
                <div class="mt-6 flex flex-col sm:flex-row justify-between items-center text-gray-300 gap-4">
                    <div class="text-sm">
                        Showing <span id="itemsFrom" class="font-medium text-yellow-500">1</span> to 
                        <span id="itemsTo" class="font-medium text-yellow-500">10</span> of 
                        <span id="totalItems" class="font-medium">0</span> return requests
                    </div>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button id="firstPage" class="pagination-btn" aria-label="Go to first page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                            </svg>
                        </button>
                        <button id="prevPage" class="pagination-btn" aria-label="Go to previous page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div id="paginationNumbers" class="flex gap-1">
                            <!-- Page numbers will be populated by JavaScript -->
                        </div>
                        <button id="nextPage" class="pagination-btn" aria-label="Go to next page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                        <button id="lastPage" class="pagination-btn" aria-label="Go to last page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <label for="pageSizeSelect" class="text-gray-400">Show:</label>
                        <select id="pageSizeSelect" class="bg-[#111111] border border-[#222222] rounded-md px-2 py-1 text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div id="responseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#1A1A1A] rounded-lg p-6 max-w-md w-full mx-4 border border-[#333333]">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-white" id="modalTitle">Enter Response</h3>
            <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mb-4 text-gray-300">
            <div class="font-semibold mb-2">Return Request Details:</div>
            <div id="requestDetails" class="bg-[#2A2A2A] p-3 rounded space-y-2">
                <p><span class="font-medium text-gray-400">Customer:</span> <span id="customerName" class="text-white"></span></p>
                <p><span class="font-medium text-gray-400">Product:</span> <span id="productName" class="text-white"></span></p>
                <p><span class="font-medium text-gray-400">Reason:</span> <span id="returnReason" class="text-white"></span></p>
            </div>
        </div>
        <div class="mb-4">
            <textarea id="adminResponse" rows="4" 
                      class="w-full bg-[#2A2A2A] text-white rounded p-3 focus:outline-none focus:ring-2 focus:ring-yellow-500 border border-[#333333]"
                      placeholder="Enter your response (10-500 characters)..."
                      maxlength="500"></textarea>
            <div class="flex justify-between items-center mt-1 text-xs">
                <span class="text-gray-500">Minimum 10 characters required</span>
                <span id="charCount" class="text-gray-400">
                    <span id="currentChars">0</span> / 500
                </span>
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancelModalBtn" 
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white transition-colors">
                Cancel
            </button>
            <button type="button" id="submitResponseBtn" 
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white transition-colors">
                Submit
            </button>
        </div>
    </div>
</div>

<style>
    .pagination-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background-color: #111111;
        border: 1px solid #222222;
        border-radius: 0.375rem;
        color: #e5e7eb;
        transition: all 200ms;
        cursor: pointer;
    }
    
    .pagination-btn:hover:not(:disabled) {
        background-color: #1A1A1A;
        border-color: #333333;
    }
    
    .pagination-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5);
    }
    
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .page-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background-color: #111111;
        border: 1px solid #222222;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #e5e7eb;
        transition: all 200ms;
        cursor: pointer;
    }
    
    .page-number:hover:not(.active) {
        background-color: #1A1A1A;
        border-color: #333333;
    }
    
    .page-number:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5);
    }
    
    .page-number.active {
        background-color: #eab308;
        border-color: #ca8a04;
        color: #000000;
        font-weight: 600;
    }
    
    .page-number.active:hover {
        background-color: #facc15;
    }
    
    .page-ellipsis {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        color: #9ca3af;
    }
</style>

<script>
    // ===========================
    // STATE MANAGEMENT
    // ===========================
    const state = {
        currentPage: 1,
        totalPages: 1,
        totalItems: 0,
        itemsPerPage: 10,
        searchQuery: "",
        statusFilter: "all",
        sortField: "order_id",
        sortDirection: "desc",
        isMobile: window.innerWidth < 768,
        isLoading: true,
        currentRequestId: null,
        currentAction: null,
        returnRequests: []
    };

    // ===========================
    // DOM ELEMENTS CACHE
    // ===========================
    const elements = {
        searchInput: document.getElementById('searchInput'),
        statusFilterSelect: document.getElementById('statusFilter'),
        filterButton: document.getElementById('filterButton'),
        filterMenu: document.getElementById('filterMenu'),
        loadingSkeleton: document.getElementById('loadingSkeleton'),
        desktopTableView: document.getElementById('desktopTableView'),
        mobileCardView: document.getElementById('mobileCardView'),
        emptyState: document.getElementById('emptyState'),
        returnRequestsTableBody: document.getElementById('returnRequestsTableBody'),
        itemsFromEl: document.getElementById('itemsFrom'),
        itemsToEl: document.getElementById('itemsTo'),
        totalItemsEl: document.getElementById('totalItems'),
        paginationNumbers: document.getElementById('paginationNumbers'),
        firstPageBtn: document.getElementById('firstPage'),
        prevPageBtn: document.getElementById('prevPage'),
        nextPageBtn: document.getElementById('nextPage'),
        lastPageBtn: document.getElementById('lastPage'),
        pageSizeSelect: document.getElementById('pageSizeSelect'),
        responseModal: document.getElementById('responseModal'),
        closeModalBtn: document.getElementById('closeModalBtn'),
        cancelModalBtn: document.getElementById('cancelModalBtn'),
        submitResponseBtn: document.getElementById('submitResponseBtn'),
        adminResponse: document.getElementById('adminResponse'),
        modalTitle: document.getElementById('modalTitle'),
        customerName: document.getElementById('customerName'),
        productName: document.getElementById('productName'),
        returnReason: document.getElementById('returnReason')
    };

    // ===========================
    // UTILITY FUNCTIONS
    // ===========================
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getStatusStyles(status) {
        if (!status) return "bg-[#1A1A1A] text-gray-400";
        
        const normalizedStatus = status.toUpperCase();
        const styles = {
            "PENDING": "bg-yellow-500/20 text-yellow-500",
            "APPROVED": "bg-green-500/20 text-green-500",
            "REJECTED": "bg-red-500/20 text-red-500"
        };
        
        return styles[normalizedStatus] || "bg-[#1A1A1A] text-gray-400";
    }

    function getStatusDisplay(status) {
        if (!status) return "Unknown";
        
        const normalizedStatus = status.toUpperCase();
        const displays = {
            "PENDING": "Pending",
            "APPROVED": "Approved",
            "REJECTED": "Rejected"
        };
        
        return displays[normalizedStatus] || status;
    }

    function getSortIcon(field) {
        if (state.sortField !== field) return "";
        return state.sortDirection === "asc" 
            ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(icon => {
            const field = icon.closest('th').dataset.sort;
            if (field) {
                icon.innerHTML = getSortIcon(field);
            }
        });
    }

    function showSuccessMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in';
        messageElement.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>${message}</span>
        `;
        
        document.body.appendChild(messageElement);
        
        setTimeout(() => {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(-10px)';
            messageElement.style.transition = 'all 0.3s ease';
            setTimeout(() => messageElement.remove(), 300);
        }, 3000);
    }

    function showValidationError(message) {
        // Remove any existing validation error
        const existingError = document.getElementById('validationError');
        if (existingError) {
            existingError.remove();
        }

        // Create new validation error
        const errorElement = document.createElement('div');
        errorElement.id = 'validationError';
        errorElement.className = 'mt-2 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm flex items-start gap-2';
        errorElement.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
            <span>${message}</span>
        `;

        // Insert after textarea
        elements.adminResponse.parentNode.insertBefore(errorElement, elements.adminResponse.nextSibling);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (document.getElementById('validationError')) {
                errorElement.style.opacity = '0';
                errorElement.style.transition = 'opacity 0.3s ease';
                setTimeout(() => errorElement.remove(), 300);
            }
        }, 5000);
    }

    function showError(message) {
        console.error('Error:', message);
        
        elements.returnRequestsTableBody.innerHTML = '';
        elements.mobileCardView.innerHTML = '';
        
        elements.emptyState.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-red-500 font-semibold text-lg mb-2">Error Loading Data</p>
                <p class="text-gray-400 text-center mb-4">${message}</p>
                <button id="retryButton" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-white font-medium transition-colors">
                    Try Again
                </button>
            </div>
        `;
        
        elements.emptyState.classList.remove('hidden');
        
        const retryButton = document.getElementById('retryButton');
        if (retryButton) {
            retryButton.addEventListener('click', () => {
                fetchReturnRequests(state.currentPage, state.searchQuery);
            });
        }
    }

    // ===========================
    // API FUNCTIONS
    // ===========================
    
    function fetchReturnRequests(page = 1, search = '', callback) {
        state.isLoading = true;
        state.currentPage = page;
        updateUI();

        let apiUrl = `/manager/api/return-requests/?page=${page}&items_per_page=${state.itemsPerPage}`;
        
        if (search) {
            apiUrl += `&search=${encodeURIComponent(search)}`;
        }
        
        if (state.statusFilter !== 'all') {
            apiUrl += `&status=${state.statusFilter}`;
        }
        
        apiUrl += `&sort_field=${state.sortField}&sort_direction=${state.sortDirection}`;
        
        console.log('Fetching data from:', apiUrl);
        
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            
            if (data.success) {
                state.returnRequests = data.return_requests;
                state.totalItems = data.total_items;
                state.totalPages = data.total_pages;
                state.currentPage = data.current_page;
                
                updateTable(state.returnRequests);
                updatePaginationInfo();
                updatePaginationControls();
                
                elements.emptyState.classList.add('hidden');
                
                if (typeof callback === 'function') {
                    callback();
                }
            } else {
                showError(data.message || 'Could not load return requests');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError(`Could not load return requests: ${error.message}. Please try again.`);
        })
        .finally(() => {
            state.isLoading = false;
            updateUI();
        });
    }

    function submitResponse() {
        const responseText = elements.adminResponse.value.trim();
        
        // Validation 1: Check if response is empty
        if (!responseText) {
            showValidationError('Please enter a response message');
            elements.adminResponse.focus();
            return;
        }

        // Validation 2: Check minimum length (at least 10 characters)
        if (responseText.length < 10) {
            showValidationError('Response must be at least 10 characters long');
            elements.adminResponse.focus();
            return;
        }

        // Validation 3: Check maximum length (max 500 characters)
        if (responseText.length > 500) {
            showValidationError('Response must not exceed 500 characters');
            elements.adminResponse.focus();
            return;
        }

        // Validation 4: Check for valid characters (no special characters only)
        const validTextPattern = /^[a-zA-Z0-9\s\.,!?'-]+$/;
        if (!validTextPattern.test(responseText)) {
            showValidationError('Response contains invalid characters. Please use only letters, numbers, and basic punctuation');
            elements.adminResponse.focus();
            return;
        }

        // Validation 5: Check if it's not just spaces or punctuation
        const meaningfulText = responseText.replace(/[\s\.,!?'-]/g, '');
        if (meaningfulText.length < 5) {
            showValidationError('Please provide a meaningful response with actual content');
            elements.adminResponse.focus();
            return;
        }

        if (!state.currentRequestId) {
            showValidationError('Error: Missing request ID. Please try again.');
            closeModal();
            return;
        }

        if (!['approve', 'reject'].includes(state.currentAction)) {
            showValidationError('Error: Invalid action. Please try again.');
            closeModal();
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showValidationError('Security token not found. Please refresh the page.');
            closeModal();
            return;
        }

        console.log('Submitting:', {
            requestId: state.currentRequestId,
            action: state.currentAction,
            response: responseText
        });

        state.isLoading = true;
        updateUI();
        closeModal();

        const requestUrl = `/manager/handle-return-request/${state.currentRequestId}/`;
        
        fetch(requestUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value
            },
            body: JSON.stringify({
                action: state.currentAction,
                response: responseText
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Something went wrong');
                }).catch(() => {
                    throw new Error(`Server error: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            state.isLoading = false;
            
            if (data.success) {
                const requestIndex = state.returnRequests.findIndex(req => 
                    String(req.id) === String(state.currentRequestId)
                );
                
                if (requestIndex !== -1) {
                    state.returnRequests[requestIndex].status = state.currentAction === 'approve' ? 'APPROVED' : 'REJECTED';
                    state.returnRequests[requestIndex].admin_response = responseText;
                }
                
                showSuccessMessage(`Return request ${state.currentAction}d successfully`);
                fetchReturnRequests(state.currentPage, state.searchQuery);
            } else {
                showError(data.message || 'An error occurred');
                updateUI();
            }
        })
        .catch(error => {
            state.isLoading = false;
            console.error('Submit error:', error);
            showError(`Error: ${error.message}`);
            updateUI();
            
            setTimeout(() => {
                fetchReturnRequests(state.currentPage, state.searchQuery);
            }, 3000);
        });
    }

    // ===========================
    // UI UPDATE FUNCTIONS
    // ===========================
    
    function updateTable(requests) {
        elements.returnRequestsTableBody.innerHTML = '';
        elements.mobileCardView.innerHTML = '';

        if (requests.length === 0) {
            elements.emptyState.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p class="text-gray-400 text-lg">No return requests found</p>
                    <p class="text-gray-500 text-sm mt-2">Try adjusting your search or filters</p>
                </div>
            `;
            elements.emptyState.classList.remove('hidden');
            return;
        }

        elements.emptyState.classList.add('hidden');

        // Populate desktop table
        requests.forEach(request => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-[#111111] transition-colors duration-200';
            
            let actionsContent = '';
            if (request.status === 'PENDING') {
                actionsContent = `
                    <div class="flex space-x-2">
                        <button onclick="handleReturn('${request.id}', 'approve')" 
                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-white text-sm font-medium transition-colors">
                            Approve
                        </button>
                        <button onclick="handleReturn('${request.id}', 'reject')"
                                class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-white text-sm font-medium transition-colors">
                            Reject
                        </button>
                    </div>
                `;
            } else {
                actionsContent = `
                    <div class="text-gray-400">
                        <div class="font-semibold text-xs mb-1">Admin Response:</div>
                        <p class="text-sm">${request.admin_response || 'No response provided'}</p>
                    </div>
                `;
            }
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${request.order_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${request.customer}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${request.product}</td>
                <td class="px-6 py-4 text-sm text-gray-300">${request.reason}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusStyles(request.status)}">
                        ${getStatusDisplay(request.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${actionsContent}
                </td>
            `;
            elements.returnRequestsTableBody.appendChild(tr);
        });

        // Populate mobile cards
        requests.forEach(request => {
            const card = document.createElement('div');
            card.className = 'bg-[#0F0F0F] border border-[#222222] rounded-lg overflow-hidden hover:border-[#333333] transition-colors';
            
            let actionsContent = '';
            if (request.status === 'PENDING') {
                actionsContent = `
                    <div class="flex space-x-2">
                        <button onclick="handleReturn('${request.id}', 'approve')" 
                                class="flex-1 bg-green-600 hover:bg-green-700 rounded py-2 text-white text-sm font-medium transition-colors">
                            Approve
                        </button>
                        <button onclick="handleReturn('${request.id}', 'reject')"
                                class="flex-1 bg-red-600 hover:bg-red-700 rounded py-2 text-white text-sm font-medium transition-colors">
                            Reject
                        </button>
                    </div>
                `;
            } else {
                actionsContent = `
                    <div class="text-gray-400 p-3 bg-[#0A0A0A] rounded">
                        <div class="font-semibold text-xs mb-1">Admin Response:</div>
                        <p class="text-sm">${request.admin_response || 'No response provided'}</p>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="p-4 border-b border-[#222222] flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium text-gray-200">Order #${request.order_id}</p>
                        <p class="text-xs text-gray-400 mt-1">${request.customer}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusStyles(request.status)}">
                        ${getStatusDisplay(request.status)}
                    </span>
                </div>
                <div class="p-4 space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-400">Product:</span>
                        <span class="text-sm text-gray-200">${request.product}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-400">Reason:</span>
                        <p class="text-sm text-gray-200 mt-1">${request.reason}</p>
                    </div>
                </div>
                <div class="p-4 bg-[#0A0A0A] border-t border-[#222222]">
                    ${actionsContent}
                </div>
            `;
            elements.mobileCardView.appendChild(card);
        });
    }

    function updatePaginationInfo() {
        const from = state.totalItems === 0 ? 0 : ((state.currentPage - 1) * state.itemsPerPage) + 1;
        const to = Math.min(state.currentPage * state.itemsPerPage, state.totalItems);
        
        elements.itemsFromEl.textContent = from;
        elements.itemsToEl.textContent = to;
        elements.totalItemsEl.textContent = state.totalItems;
    }

    function updatePaginationControls() {
        elements.paginationNumbers.innerHTML = '';
        
        elements.firstPageBtn.disabled = state.currentPage === 1;
        elements.prevPageBtn.disabled = state.currentPage === 1;
        elements.nextPageBtn.disabled = state.currentPage === state.totalPages;
        elements.lastPageBtn.disabled = state.currentPage === state.totalPages;
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(state.totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
            addPageNumber(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            addPageNumber(i);
        }
        
        if (endPage < state.totalPages) {
            if (endPage < state.totalPages - 1) {
                addEllipsis();
            }
            addPageNumber(state.totalPages);
        }
    }
    
    function addPageNumber(pageNum) {
        const pageButton = document.createElement('button');
        pageButton.className = `page-number ${pageNum === state.currentPage ? 'active' : ''}`;
        pageButton.textContent = pageNum;
        pageButton.addEventListener('click', () => {
            if (pageNum !== state.currentPage) {
                fetchReturnRequests(pageNum, state.searchQuery);
            }
        });
        elements.paginationNumbers.appendChild(pageButton);
    }
    
    function addEllipsis() {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        elements.paginationNumbers.appendChild(ellipsis);
    }

    function updateUI() {
        if (state.isLoading) {
            elements.loadingSkeleton.classList.remove('hidden');
            elements.desktopTableView.classList.add('hidden');
            elements.mobileCardView.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
        } else {
            elements.loadingSkeleton.classList.add('hidden');
            
            if (state.isMobile) {
                elements.desktopTableView.classList.add('hidden');
                elements.mobileCardView.classList.remove('hidden');
            } else {
                elements.desktopTableView.classList.remove('hidden');
                elements.mobileCardView.classList.add('hidden');
            }
            
            updateSortIcons();
        }
    }

    function checkIfMobile() {
        const wasMobile = state.isMobile;
        state.isMobile = window.innerWidth < 768;
        
        if (wasMobile !== state.isMobile) {
            updateUI();
        }
    }

    // ===========================
    // MODAL FUNCTIONS
    // ===========================
    
    function handleReturn(requestId, action) {
        state.currentRequestId = requestId;
        state.currentAction = action;
        
        console.log(`Processing: Request ID ${requestId}, Action: ${action}`);
        
        if (!state.returnRequests || state.returnRequests.length === 0) {
            console.log('No data loaded, fetching...');
            fetchReturnRequests(1, '', () => handleReturn(requestId, action));
            return;
        }
        
        const request = state.returnRequests.find(req => 
            String(req.id) === String(requestId)
        );
        
        if (!request) {
            console.error(`Request ${requestId} not found in current data`);
            showError(`Request #${requestId} not found. Please refresh the page.`);
            return;
        }
        
        console.log('Found request:', request);
        
        elements.modalTitle.textContent = action === 'approve' 
            ? 'Approve Return Request' 
            : 'Reject Return Request';
        
        elements.customerName.textContent = request.customer;
        elements.productName.textContent = request.product;
        elements.returnReason.textContent = request.reason;
        
        elements.responseModal.classList.remove('hidden');
        elements.responseModal.classList.add('flex');
        elements.adminResponse.focus();
    }

    function closeModal() {
        console.log('Closing modal');
        elements.responseModal.classList.add('hidden');
        elements.responseModal.classList.remove('flex');
        elements.adminResponse.value = '';
        
        state.currentRequestId = null;
        state.currentAction = null;
    }

    // ===========================
    // EVENT LISTENERS SETUP
    // ===========================
    
    function setupEventListeners() {
        // Search input
        elements.searchInput.addEventListener('input', debounce(() => {
            state.searchQuery = elements.searchInput.value;
            fetchReturnRequests(1, state.searchQuery);
        }, 300));

        // Status filter
        elements.statusFilterSelect.addEventListener('change', () => {
            state.statusFilter = elements.statusFilterSelect.value;
            fetchReturnRequests(1, state.searchQuery);
        });

        // Filter dropdown toggle
        elements.filterButton.addEventListener('click', () => {
            elements.filterMenu.classList.toggle('hidden');
        });

        // Close filter menu when clicking outside
        document.addEventListener('click', (event) => {
            const isClickInside = elements.filterButton.contains(event.target) || 
                                 elements.filterMenu.contains(event.target);
            if (!isClickInside && !elements.filterMenu.classList.contains('hidden')) {
                elements.filterMenu.classList.add('hidden');
            }
        });

        // Pagination controls
        elements.firstPageBtn.addEventListener('click', () => {
            if (state.currentPage !== 1) {
                fetchReturnRequests(1, state.searchQuery);
            }
        });

        elements.prevPageBtn.addEventListener('click', () => {
            if (state.currentPage > 1) {
                fetchReturnRequests(state.currentPage - 1, state.searchQuery);
            }
        });

        elements.nextPageBtn.addEventListener('click', () => {
            if (state.currentPage < state.totalPages) {
                fetchReturnRequests(state.currentPage + 1, state.searchQuery);
            }
        });

        elements.lastPageBtn.addEventListener('click', () => {
            if (state.currentPage !== state.totalPages) {
                fetchReturnRequests(state.totalPages, state.searchQuery);
            }
        });

        elements.pageSizeSelect.addEventListener('change', () => {
            state.itemsPerPage = parseInt(elements.pageSizeSelect.value);
            fetchReturnRequests(1, state.searchQuery);
        });

        // Column sorting
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (state.sortField === field) {
                    state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortField = field;
                    state.sortDirection = 'asc';
                }
                fetchReturnRequests(1, state.searchQuery);
            });
        });

        // Modal event listeners
        if (elements.closeModalBtn) {
            elements.closeModalBtn.addEventListener('click', closeModal);
        }

        if (elements.cancelModalBtn) {
            elements.cancelModalBtn.addEventListener('click', closeModal);
        }

        if (elements.submitResponseBtn) {
            elements.submitResponseBtn.addEventListener('click', submitResponse);
        }

        // Close modal when clicking outside
        elements.responseModal.addEventListener('click', (event) => {
            if (event.target === elements.responseModal) {
                closeModal();
            }
        });

        // Keyboard support
        document.addEventListener('keydown', (event) => {
            if (!elements.responseModal.classList.contains('hidden')) {
                if (event.key === 'Escape') {
                    closeModal();
                } else if (event.key === 'Enter' && event.ctrlKey) {
                    submitResponse();
                }
            }
        });

        // Character counter for response textarea
        elements.adminResponse.addEventListener('input', () => {
            const currentLength = elements.adminResponse.value.length;
            const charCountSpan = document.getElementById('currentChars');
            const charCountContainer = document.getElementById('charCount');
            
            if (charCountSpan) {
                charCountSpan.textContent = currentLength;
                
                // Change color based on character count
                if (currentLength < 10) {
                    charCountContainer.className = 'text-red-400';
                } else if (currentLength > 450) {
                    charCountContainer.className = 'text-yellow-400';
                } else {
                    charCountContainer.className = 'text-green-400';
                }
            }

            // Remove validation error on input
            const existingError = document.getElementById('validationError');
            if (existingError) {
                existingError.remove();
            }
        });

        // Window resize
        window.addEventListener('resize', debounce(checkIfMobile, 100));
    }

    // ===========================
    // INITIALIZATION
    // ===========================
    
    function init() {
        console.log('Initializing Return Requests Manager...');
        
        // Verify all critical elements exist
        const criticalElements = [
            'searchInput', 'statusFilterSelect', 'filterButton', 'filterMenu',
            'loadingSkeleton', 'desktopTableView', 'mobileCardView', 'emptyState',
            'returnRequestsTableBody', 'responseModal', 'closeModalBtn', 
            'cancelModalBtn', 'submitResponseBtn'
        ];
        
        const missingElements = criticalElements.filter(id => !elements[id]);
        
        if (missingElements.length > 0) {
            console.error('Missing critical elements:', missingElements);
            return;
        }
        
        setupEventListeners();
        fetchReturnRequests();
        
        console.log('Initialization complete');
    }

    // Make handleReturn available globally for onclick attributes
    window.handleReturn = handleReturn;

    // Start the application
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>
{% endblock %}