{% extends 'base01.html' %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-black py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-600 bg-clip-text text-transparent">
                Return Requests
            </h1>
            <p class="mt-2 text-sm text-gray-400">Manage and process customer return requests</p>
        </div>

        <!-- Main Card -->
        <div class="bg-[#0A0A0A] border border-[#222222] rounded-xl shadow-xl overflow-hidden">
            <div class="p-6 pb-3 border-b border-[#222222]">
                <h2 class="text-xl text-gray-200">Return Requests</h2>
                <p class="text-sm text-gray-400">View and manage all customer return requests in one place</p>
            </div>
            
            <div class="p-6">
                <!-- Search and Filter Section -->
                <div class="mb-6 space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input 
                                type="text" 
                                id="searchInput"
                                placeholder="Search by order ID or customer..." 
                                class="w-full pl-9 pr-4 py-2 rounded-md bg-[#111111] border border-[#222222] text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                            >
                        </div>
                        <div class="flex gap-2">
                            <div class="relative inline-block text-left" id="filterDropdown">
                                <button type="button" id="filterButton" class="inline-flex items-center px-4 py-2 bg-[#111111] border border-[#222222] rounded-md text-gray-200 hover:bg-opacity-80 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                    </svg>
                                    Filters
                                </button>
                                <div id="filterMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-[#111111] border border-[#222222] z-10">
                                    <div class="p-2">
                                        <p class="text-xs font-medium text-gray-400 mb-2">Status</p>
                                        <select id="statusFilter" class="w-full bg-[#0A0A0A] border border-[#222222] rounded-md p-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                            <option value="all">All Statuses</option>
                                            <option value="PENDING">Pending</option>
                                            <option value="APPROVED">Approved</option>
                                            <option value="REJECTED">Rejected</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Skeleton (shown while loading) -->
                <div id="loadingSkeleton" class="rounded-md border border-[#222222] overflow-hidden">
                    <table class="min-w-full divide-y divide-[#222222]">
                        <thead class="bg-[#111111]">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Order ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Skeleton rows -->
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded"></div></td>
                            </tr>
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded"></div></td>
                            </tr>
                            <tr class="border-b border-[#222222]">
                                <td class="px-6 py-4"><div class="h-4 w-16 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-24 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-32 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-4 w-40 bg-[#222222] rounded"></div></td>
                                <td class="px-6 py-4"><div class="h-6 w-20 bg-[#222222] rounded-full"></div></td>
                                <td class="px-6 py-4"><div class="h-8 w-32 bg-[#222222] rounded"></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Desktop Table View -->
                <div id="desktopTableView" class="rounded-md border border-[#222222] overflow-hidden hidden md:block">
                    <table class="min-w-full divide-y divide-[#222222]">
                        <thead class="bg-[#111111]">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" data-sort="order_id">
                                    <div class="flex items-center">
                                        Order ID
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" data-sort="customer">
                                    <div class="flex items-center">
                                        Customer
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" data-sort="product">
                                    <div class="flex items-center">
                                        Product
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Reason
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" data-sort="status">
                                    <div class="flex items-center">
                                        Status
                                        <span class="sort-icon ml-1"></span>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="returnRequestsTableBody" class="bg-[#0A0A0A] divide-y divide-[#222222]">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div id="mobileCardView" class="md:hidden space-y-4">
                    <!-- Mobile cards will be populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden py-10 text-center text-gray-400">
                    No return requests found
                </div>

                <!-- Enhanced Pagination -->
                <div class="mt-6 flex flex-col sm:flex-row justify-between items-center text-gray-300 gap-4">
                    <div class="text-sm">
                        Showing <span id="itemsFrom" class="font-medium text-yellow-500">1</span> to 
                        <span id="itemsTo" class="font-medium text-yellow-500">10</span> of 
                        <span id="totalItems" class="font-medium">100</span> return requests
                    </div>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button id="firstPage" class="pagination-btn" aria-label="Go to first page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                            </svg>
                        </button>
                        <button id="prevPage" class="pagination-btn" aria-label="Go to previous page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div id="paginationNumbers" class="flex gap-1">
                            <!-- Page numbers will be populated by JavaScript -->
                        </div>
                        <button id="nextPage" class="pagination-btn" aria-label="Go to next page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                        <button id="lastPage" class="pagination-btn" aria-label="Go to last page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <label for="pageSizeSelect" class="text-gray-400">Show:</label>
                        <select id="pageSizeSelect" class="bg-[#111111] border border-[#222222] rounded-md px-2 py-1 text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div id="responseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#1A1A1A] rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-white" id="modalTitle">Enter Response</h3>
            <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mb-4 text-gray-300">
            <div class="font-semibold mb-2">Return Request Details:</div>
            <div id="requestDetails" class="bg-[#2A2A2A] p-3 rounded">
                <p class="mb-2"><span class="font-medium">Customer:</span> <span id="customerName"></span></p>
                <p class="mb-2"><span class="font-medium">Product:</span> <span id="productName"></span></p>
                <p class="mb-2"><span class="font-medium">Reason:</span> <span id="returnReason"></span></p>
            </div>
        </div>
        <textarea id="adminResponse" rows="4" 
                  class="w-full bg-[#2A2A2A] text-white rounded p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  placeholder="Enter your response..."></textarea>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancelModalBtn" 
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                Cancel
            </button>
            <button type="button" id="submitResponseBtn" 
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white">
                Submit
            </button>
        </div>
    </div>
</div>

<style>
    /* Pagination styles */
    .pagination-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background-color: #111111;
        border: 1px solid #222222;
        border-radius: 0.375rem;
        color: #e5e7eb;
        transition-property: background-color, border-color, color;
        transition-duration: 200ms;
    }
    
    .pagination-btn:hover:not(:disabled) {
        background-color: #1A1A1A;
    }
    
    .pagination-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5);
    }
    
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .page-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background-color: #111111;
        border: 1px solid #222222;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #e5e7eb;
        transition-property: background-color, border-color, color;
        transition-duration: 200ms;
    }
    
    .page-number:hover:not(.active) {
        background-color: #1A1A1A;
    }
    
    .page-number:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5);
    }
    
    .page-number.active {
        background-color: #eab308;
        border-color: #ca8a04;
        color: #000000;
        font-weight: 500;
    }
    
    .page-number.active:hover {
        background-color: #facc15;
    }
    
    .page-ellipsis {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        color: #9ca3af;
    }
</style>

<script>
    // State variables
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    let itemsPerPage = 10;
    let searchQuery = "";
    let statusFilter = "all";
    let sortField = "order_id";
    let sortDirection = "desc";
    let isMobile = window.innerWidth < 768;
    let isLoading = true;
    let currentRequestId = null;
    let currentAction = null;
    let returnRequests = [];

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const statusFilterSelect = document.getElementById('statusFilter');
    const filterButton = document.getElementById('filterButton');
    const filterMenu = document.getElementById('filterMenu');
    const loadingSkeleton = document.getElementById('loadingSkeleton');
    const desktopTableView = document.getElementById('desktopTableView');
    const mobileCardView = document.getElementById('mobileCardView');
    const emptyState = document.getElementById('emptyState');
    const returnRequestsTableBody = document.getElementById('returnRequestsTableBody');
    const itemsFromEl = document.getElementById('itemsFrom');
    const itemsToEl = document.getElementById('itemsTo');
    const totalItemsEl = document.getElementById('totalItems');
    const paginationNumbers = document.getElementById('paginationNumbers');
    const firstPageBtn = document.getElementById('firstPage');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const lastPageBtn = document.getElementById('lastPage');
    const pageSizeSelect = document.getElementById('pageSizeSelect');

    // Helper functions
    function getStatusStyles(status) {
        if (!status) return "bg-[#1A1A1A] text-gray-400 border-gray-700";
        
        // Normalize status to uppercase for consistent comparison
        const normalizedStatus = status.toUpperCase();
        switch (normalizedStatus) {
            case "PENDING":
                return "bg-yellow-500/20 text-yellow-500";
            case "APPROVED":
                return "bg-green-500/20 text-green-500";
            case "REJECTED":
                return "bg-red-500/20 text-red-500";
            default:
                return "bg-[#1A1A1A] text-gray-400 border-gray-700";
        }
    }

    function getStatusDisplay(status) {
        if (!status) return "Unknown";
        
        // Normalize status to uppercase for consistent comparison
        const normalizedStatus = status.toUpperCase();
        switch (normalizedStatus) {
            case "PENDING":
                return "Pending";
            case "APPROVED":
                return "Approved";
            case "REJECTED":
                return "Rejected";
            default:
                return status;
        }
    }

    function getSortIcon(field) {
        if (sortField !== field) return "";
        return sortDirection === "asc" 
            ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(icon => {
            const field = icon.closest('th').dataset.sort;
            icon.innerHTML = getSortIcon(field);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Main functions
    // This function gets the return requests from the server
    // page: which page of results to show (starts at 1)
    // search: optional text to search for
    // callback: optional function to run after data is loaded
    function fetchReturnRequests(page = 1, search = '', callback) {
        // Show loading spinner
        isLoading = true;
        currentPage = page;
        updateUI();

        // Step 1: Build the URL for our API request
        let apiUrl = `/manager/api/return-requests/?page=${page}&items_per_page=${itemsPerPage}`;
        
        // Add search text if provided
        if (search) {
            apiUrl += `&search=${encodeURIComponent(search)}`;
        }
        
        // Add status filter if selected
        if (statusFilter !== 'all') {
            apiUrl += `&status=${statusFilter}`;
        }
        
        // Add sorting options
        apiUrl += `&sort_field=${sortField}&sort_direction=${sortDirection}`;
        
        // For debugging - shows URL in browser console
        console.log('Loading data from:', apiUrl);
        
        // Step 2: Send the request to the server
        fetch(apiUrl, {
            method: 'GET',  // We're just getting data, not changing anything
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')  // Security token
            }
        })
        // Step 3: Check if the response is OK
        .then(response => {
            console.log('Server response status:', response.status);
            
            // If there's an error with the response
            if (!response.ok) {
                throw new Error(`Server error! Status: ${response.status}`);
            }
            
            // Convert response to JSON
            return response.json();
        })
        // Step 4: Process the data we received
        .then(data => {
            console.log('Data received:', data);
            
            // If the server says everything is OK
            if (data.success) {
                // Save the data we received
                returnRequests = data.return_requests;
                totalItems = data.total_items;
                totalPages = data.total_pages;
                currentPage = data.current_page;
                
                // Update what the user sees on screen
                updateTable(returnRequests);
                updatePaginationInfo();
                updatePaginationControls();
                
                // Hide any error messages
                emptyState.classList.add('hidden');
                
                // Run the callback function if one was provided
                if (typeof callback === 'function') {
                    callback();
                }
            } else {
                // Show error from the server
                showError(data.message || 'Could not load return requests');
            }
        })
        // Step 5: Handle any errors that occurred
        .catch(error => {
            console.error('Error:', error);
            showError(`Could not load return requests: ${error.message}. Please try again.`);
        })
        // Step 6: Always run this code at the end
        .finally(() => {
            // Hide loading spinner
            isLoading = false;
            updateUI();
        });
    }

    function extractReturnRequestsFromDOM() {
        // Extract return requests from the existing DOM
        const rows = document.querySelectorAll('tbody tr');
        returnRequests = [];
        
        rows.forEach(row => {
            if (row.cells && row.cells.length >= 6) {
                const orderId = row.cells[0].textContent.trim();
                const customer = row.cells[1].textContent.trim();
                const product = row.cells[2].textContent.trim();
                const reason = row.cells[3].textContent.trim();
                const statusElement = row.cells[4].querySelector('span');
                const status = statusElement ? statusElement.textContent.trim() : '';
                const actionsCell = row.cells[5];
                
                // Extract request ID from the button onclick attribute if it exists
                let requestId = '';
                const approveButton = actionsCell.querySelector('button[onclick*="handleReturn"]');
                if (approveButton) {
                    const onclickAttr = approveButton.getAttribute('onclick');
                    const match = onclickAttr.match(/handleReturn\('([^']+)'/);
                    if (match && match[1]) {
                        requestId = match[1];
                    }
                }
                
                // Extract admin response if available
                let adminResponse = '';
                const responseElement = actionsCell.querySelector('.text-gray-500 p');
                if (responseElement) {
                    adminResponse = responseElement.textContent.trim();
                }
                
                returnRequests.push({
                    id: requestId,
                    order_id: orderId,
                    customer: customer,
                    product: product,
                    reason: reason,
                    status: status.toUpperCase(),
                    admin_response: adminResponse
                });
            }
        });
    }

    // This function shows an error message to the user
    function showError(message) {
        console.log('Error:', message);
        
        // Clear the table contents
        returnRequestsTableBody.innerHTML = '';
        mobileCardView.innerHTML = '';
        
        // Create a nice-looking error message
        emptyState.innerHTML = `
            <div class="flex flex-col items-center justify-center p-6">
                <!-- Error icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <!-- Error title -->
                <p class="text-red-500 font-medium text-lg mb-2">Error</p>
                <!-- Error message -->
                <p class="text-gray-400 text-center">${message}</p>
                <!-- Retry button -->
                <button id="retryButton" class="mt-4 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white">
                    Try Again
                </button>
            </div>
        `;
        
        // Show the error message
        emptyState.classList.remove('hidden');
        
        // Make the retry button work
        document.getElementById('retryButton').addEventListener('click', function() {
            // Try to load the data again
            fetchReturnRequests(currentPage, searchQuery);
        });
    }

    function updateTable(requests) {
        // Update desktop table
        returnRequestsTableBody.innerHTML = '';
        
        // Update mobile cards
        mobileCardView.innerHTML = '';

        if (requests.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        // Populate desktop table
        requests.forEach(request => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-[#111111] cursor-pointer transition-colors duration-200';
            
            // Create actions cell content based on status
            let actionsContent = '';
            if (request.status === 'PENDING') {
                actionsContent = `
                    <div class="flex space-x-2">
                        <button onclick="handleReturn('${request.id}', 'approve')" 
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-white text-sm">
                            Approve
                        </button>
                        <button onclick="handleReturn('${request.id}', 'reject')"
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-white text-sm">
                            Reject
                        </button>
                    </div>
                `;
            } else {
                actionsContent = `
                    <div class="text-gray-500">
                        <div class="font-semibold mb-1">Admin Response:</div>
                        <p>${request.admin_response || 'No response provided'}</p>
                    </div>
                `;
            }
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${request.order_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${request.customer}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${request.product}</td>
                <td class="px-6 py-4 text-sm text-gray-300">${request.reason}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 rounded-full text-sm ${getStatusStyles(request.status)}">
                        ${getStatusDisplay(request.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${actionsContent}
                </td>
            `;
            returnRequestsTableBody.appendChild(tr);
        });

        // Populate mobile cards
        requests.forEach(request => {
            const card = document.createElement('div');
            card.className = 'bg-[#0F0F0F] border border-[#222222] rounded-lg overflow-hidden';
            
            // Create actions content based on status
            let actionsContent = '';
            if (request.status === 'PENDING') {
                actionsContent = `
                    <div class="flex space-x-2">
                        <button onclick="handleReturn('${request.id}', 'approve')" 
                                class="flex-1 bg-green-600 hover:bg-green-700 rounded py-2 text-white text-sm">
                            Approve
                        </button>
                        <button onclick="handleReturn('${request.id}', 'reject')"
                                class="flex-1 bg-red-600 hover:bg-red-700 rounded py-2 text-white text-sm">
                            Reject
                        </button>
                    </div>
                `;
            } else {
                actionsContent = `
                    <div class="text-gray-500 p-3 bg-[#0A0A0A] rounded">
                        <div class="font-semibold mb-1">Admin Response:</div>
                        <p>${request.admin_response || 'No response provided'}</p>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="p-4 border-b border-[#222222] flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium text-gray-200">Order #${request.order_id}</p>
                        <p class="text-xs text-gray-400">${request.customer}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs ${getStatusStyles(request.status)}">
                        ${getStatusDisplay(request.status)}
                    </span>
                </div>
                <div class="p-4 space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-400">Product:</span>
                        <span class="text-sm text-gray-200">${request.product}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-400">Reason:</span>
                        <p class="text-sm text-gray-200 mt-1">${request.reason}</p>
                    </div>
                </div>
                <div class="p-4 bg-[#0A0A0A] border-t border-[#222222]">
                    ${actionsContent}
                </div>
            `;
            mobileCardView.appendChild(card);
        });
    }

    function updatePaginationInfo() {
        const from = totalItems === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
        const to = Math.min(currentPage * itemsPerPage, totalItems);
        
        itemsFromEl.textContent = from;
        itemsToEl.textContent = to;
        totalItemsEl.textContent = totalItems;
    }

    function updatePaginationControls() {
        // Clear existing page numbers
        paginationNumbers.innerHTML = '';
        
        // Disable/enable first/last/prev/next buttons
        firstPageBtn.disabled = currentPage === 1;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        lastPageBtn.disabled = currentPage === totalPages;
        
        // Generate page numbers with ellipsis for large page counts
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Add first page and ellipsis if needed
        if (startPage > 1) {
            addPageNumber(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }
        
        // Add visible page numbers
        for (let i = startPage; i <= endPage; i++) {
            addPageNumber(i);
        }
        
        // Add ellipsis and last page if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                addEllipsis();
            }
            addPageNumber(totalPages);
        }
    }
    
    function addPageNumber(pageNum) {
        const pageButton = document.createElement('button');
        pageButton.className = `page-number ${pageNum === currentPage ? 'active' : ''}`;
        pageButton.textContent = pageNum;
        pageButton.addEventListener('click', () => {
            if (pageNum !== currentPage) {
                fetchReturnRequests(pageNum, searchQuery);
            }
        });
        paginationNumbers.appendChild(pageButton);
    }
    
    function addEllipsis() {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        paginationNumbers.appendChild(ellipsis);
    }

    function updateUI() {
        if (isLoading) {
            loadingSkeleton.classList.remove('hidden');
            desktopTableView.classList.add('hidden');
            mobileCardView.classList.add('hidden');
            emptyState.classList.add('hidden');
        } else {
            loadingSkeleton.classList.add('hidden');
            
            if (isMobile) {
                desktopTableView.classList.add('hidden');
                mobileCardView.classList.remove('hidden');
            } else {
                desktopTableView.classList.remove('hidden');
                mobileCardView.classList.add('hidden');
            }
            
            updateSortIcons();
        }
    }

    function checkIfMobile() {
        const wasMobile = isMobile;
        isMobile = window.innerWidth < 768;
        
        if (wasMobile !== isMobile) {
            updateUI();
        }
    }

    // This function handles when a user clicks Approve or Reject button
    // requestId: the ID of the return request to handle
    // action: either 'approve' or 'reject'
    function handleReturn(requestId, action) {
        // Save the current request ID and action for later use
        currentRequestId = requestId;
        currentAction = action;
        
        console.log(`Processing return request: ${requestId}, action: ${action}`);
        
        // Step 1: Check if we have any data loaded
        if (!returnRequests || returnRequests.length === 0) {
            // We don't have any data yet, so let's load it first
            showError('Loading data, please wait...');
            
            // Load the data and then try again
            fetchReturnRequests(1, '', function() {
                // This will run after data is loaded
                handleReturn(requestId, action);
            });
            return;  // Stop here until data is loaded
        }
        
        // Step 2: Find the request in our data
        // Convert requestId to a number for consistent comparison
        const requestIdNum = parseInt(requestId, 10);
        console.log('Looking for request ID (as number):', requestIdNum);
        
        // Debug: Log all request IDs in our data to help troubleshoot
        console.log('All request IDs in local data:', returnRequests.map(req => req.id));
        
        const request = returnRequests.find(function(req) {
            // Use loose equality (==) or convert both to same type for comparison
            return req.id == requestId || parseInt(req.id, 10) === requestIdNum;
        });
        
        // Step 3: If request not found, try to get it from server
        if (!request) {
            console.log(`Request ${requestId} not found in current data`);
            showError('Finding your request...');
            
            // Try to get this specific request
            getRequestFromServer();
            return;  // Stop here until we find the request
        }
        
        // Step 4: We found the request, show the response modal
        console.log('Found request:', request);
        
        // Set the modal title based on action
        let modalTitle = document.getElementById('modalTitle');
        if (action === 'approve') {
            modalTitle.textContent = 'Approve Return Request';
        } else {
            modalTitle.textContent = 'Reject Return Request';
        }
        
        // Fill in request details
        document.getElementById('customerName').textContent = request.customer;
        document.getElementById('productName').textContent = request.product;
        document.getElementById('returnReason').textContent = request.reason;
        
        // Show the modal
        document.getElementById('responseModal').classList.remove('hidden');
        document.getElementById('responseModal').classList.add('flex');
        
        // Helper function to get a specific request from server
        function getRequestFromServer() {
            // Show loading message
            showError('Looking for request data...');
            
            // Try to get all requests without filtering first
            // This ensures we get all data regardless of current filters
            fetch(`/manager/api/return-requests/?items_per_page=100`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(function(response) {
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`Server error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('All requests data:', data);
                
                // Check if we got any data back
                if (data.success && data.return_requests && data.return_requests.length > 0) {
                    // Convert requestId to a number for consistent comparison
                    const requestIdNum = parseInt(requestId, 10);
                    console.log('Looking for request ID (as number):', requestIdNum);
                    console.log('All request IDs from server:', data.return_requests.map(req => req.id));
                    
                    // Look for our specific request ID in the returned data
                    const foundRequest = data.return_requests.find(function(req) {
                        // Try multiple comparison methods to ensure we find the request
                        return req.id == requestId || parseInt(req.id, 10) === requestIdNum || String(req.id) === String(requestId);
                    });
                    
                    if (foundRequest) {
                        console.log('Found request with ID:', foundRequest);
                        
                        // Add all requests to our data to ensure we have everything
                        returnRequests = data.return_requests;
                        
                        // Try again now that we have the data
                        handleReturn(requestId, action);
                    } else {
                        // If still not found, try a direct API call for this specific ID
                        tryDirectApiCall();
                    }
                } else {
                    // No data returned, try direct API call
                    tryDirectApiCall();
                }
            })
            .catch(function(error) {
                console.log('Error finding request:', error);
                tryDirectApiCall();
            });
            
            // Helper function to try a direct API call for the specific ID
            function tryDirectApiCall() {
                console.log('Trying direct API call for request ID:', requestId);
                
                // Make a direct API call to the backend for this specific ID
                fetch(`/manager/handle-return-request/${requestId}/info`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(function(response) {
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Request truly doesn't exist
                            throw new Error('Request not found');
                        }
                        throw new Error(`Server error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.success && data.request) {
                        // We found the request directly
                        console.log('Found request via direct API:', data.request);
                        
                        // Add to our local data
                        returnRequests.push(data.request);
                        
                        // Try again
                        handleReturn(requestId, action);
                    } else {
                        // Still not found
                        showError(`Request #${requestId} not found. The request may have been deleted or doesn't exist.`);
                    }
                })
                .catch(function(error) {
                    console.log('Error in direct API call:', error);
                    showError(`Could not find request #${requestId}: ${error.message}. Please refresh the page.`);
                });
            }
        }
    }

    // This function closes the response modal and resets its fields
    function closeModal() {
        console.log('Closing modal');
        const modal = document.getElementById('responseModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('adminResponse').value = '';
        
        // Reset the current request ID and action
        currentRequestId = null;
        currentAction = null;
    }

    // This function submits the admin's response when approving or rejecting a return
    function submitResponse() {
        // Step 1: Get the admin's response text
        const responseText = document.getElementById('adminResponse').value;
        
        // Check if response is empty
        if (!responseText.trim()) {
            alert('Please enter a response');
            return;
        }

        // Step 2: Make sure we have a valid request ID and action
        if (!currentRequestId) {
            alert('Error: Missing request ID. Please try again.');
            closeModal();
            return;
        }

        if (currentAction !== 'approve' && currentAction !== 'reject') {
            alert('Error: Please select either approve or reject.');
            closeModal();
            return;
        }

        // For debugging
        console.log('Processing request:', currentRequestId);
        console.log('Action:', currentAction);
        console.log('Response:', responseText);
        
        // Step 3: Get the security token needed for the request
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('Security token not found. Please refresh the page.');
            closeModal();
            return;
        }

        // Step 4: Show loading spinner and close the modal
        isLoading = true;
        updateUI();
        closeModal();

        // Step 5: Send the request to the server
        const requestUrl = `/manager/handle-return-request/${currentRequestId}/`;
        console.log('Sending to:', requestUrl);
        
        fetch(requestUrl, {
            method: 'POST',  // We're sending data to update the server
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value  // Security token
            },
            // Convert our data to JSON format
            body: JSON.stringify({
                action: currentAction,
                response: responseText
            })
        })
        // Step 6: Handle the server's response
        .then(function(response) {
            console.log('Response status:', response.status);
            
            // If there was an error
            if (!response.ok) {
                return response.text().then(function(text) {
                    // Try to get a detailed error message
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(`Error: ${errorData.message || 'Something went wrong'}`);
                    } catch (e) {
                        throw new Error(`Error: ${text || 'Something went wrong'}`);
                    }
                });
            }
            
            // If response was OK, convert to JSON
            return response.json();
        })
        // Step 7: Process the data we received
        .then(function(data) {
            console.log('Server response:', data);
            isLoading = false;  // Hide loading spinner
            
            // If the server says everything worked
            if (data.success) {
                // Convert ID to number for consistent comparison
                const requestIdNum = parseInt(currentRequestId, 10);
                console.log('Looking for request ID to update (as number):', requestIdNum);
                
                // Update our local data
                const requestIndex = returnRequests.findIndex(function(req) {
                    // Try multiple comparison methods to ensure we find the request
                    return req.id == currentRequestId || parseInt(req.id, 10) === requestIdNum || String(req.id) === String(currentRequestId);
                });
                
                if (requestIndex !== -1) {
                    // Update the status in our local data
                    if (currentAction === 'approve') {
                        returnRequests[requestIndex].status = 'APPROVED';
                    } else {
                        returnRequests[requestIndex].status = 'REJECTED';
                    }
                    returnRequests[requestIndex].admin_response = responseText;
                }
                
                // Show a success message
                showSuccessMessage(`Return request ${currentAction}d successfully`);
                
                // Refresh the table to show updated data
                fetchReturnRequests(currentPage, searchQuery);
            } else {
                // Show error from the server
                showError(data.message || 'An error occurred');
                updateUI();
            }
        })
        // Step 8: Handle any errors
        .catch(function(error) {
            isLoading = false;  // Hide loading spinner
            console.log('Error:', error);
            
            // Show error message
            showError(`Error: ${error.message}`);
            updateUI();
            
            // Try to refresh data after a delay
            setTimeout(function() {
                fetchReturnRequests(currentPage, searchQuery);
            }, 3000);
        });
    }
    
    // Helper function to show a success message
    function showSuccessMessage(message) {
        // Create a new message element
        const messageElement = document.createElement('div');
        messageElement.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
        messageElement.textContent = message;
        
        // Add it to the page
        document.body.appendChild(messageElement);
        
        // Remove it after 3 seconds
        setTimeout(function() {
            messageElement.remove();
        }, 3000);
    }

    // Set up modal event listeners
    function setupModalEventListeners() {
        // Get modal elements
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const submitResponseBtn = document.getElementById('submitResponseBtn');
        const responseModal = document.getElementById('responseModal');
        
        // Add click event for close button (X)
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                console.log('Close button clicked');
                closeModal();
            });
        }
        
        // Add click event for cancel button
        if (cancelModalBtn) {
            cancelModalBtn.addEventListener('click', function() {
                console.log('Cancel button clicked');
                closeModal();
            });
        }
        
        // Add click event for submit button
        if (submitResponseBtn) {
            submitResponseBtn.addEventListener('click', function() {
                console.log('Submit button clicked');
                submitResponse();
            });
        }
        
        // Close modal when clicking outside of it
        responseModal.addEventListener('click', function(event) {
            // Only close if the click was directly on the modal background (not on the modal content)
            if (event.target === responseModal) {
                closeModal();
            }
        });
        
        // Add keyboard support (Escape to close, Enter to submit)
        document.addEventListener('keydown', function(event) {
            if (!responseModal.classList.contains('hidden')) {
                if (event.key === 'Escape') {
                    closeModal();
                } else if (event.key === 'Enter' && event.ctrlKey) {
                    submitResponse();
                }
            }
        });
        
        console.log('Modal event listeners set up');
    }
    
    // Event listeners
    searchInput.addEventListener('input', debounce(() => {
        searchQuery = searchInput.value;
        fetchReturnRequests(1, searchQuery);
    }, 300));

    statusFilterSelect.addEventListener('change', () => {
        statusFilter = statusFilterSelect.value;
        fetchReturnRequests(1, searchQuery);
    });

    filterButton.addEventListener('click', () => {
        filterMenu.classList.toggle('hidden');
    });

    // Close filter menu when clicking outside
    document.addEventListener('click', (event) => {
        const isClickInside = filterButton.contains(event.target) || filterMenu.contains(event.target);
        if (!isClickInside && !filterMenu.classList.contains('hidden')) {
            filterMenu.classList.add('hidden');
        }
    });

    firstPageBtn.addEventListener('click', () => {
        if (currentPage !== 1) {
            fetchReturnRequests(1, searchQuery);
        }
    });

    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            fetchReturnRequests(currentPage - 1, searchQuery);
        }
    });

    nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            fetchReturnRequests(currentPage + 1, searchQuery);
        }
    });

    lastPageBtn.addEventListener('click', () => {
        if (currentPage !== totalPages) {
            fetchReturnRequests(totalPages, searchQuery);
        }
    });

    pageSizeSelect.addEventListener('change', () => {
        itemsPerPage = parseInt(pageSizeSelect.value);
        fetchReturnRequests(1, searchQuery);
    });

    // Sort columns
    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const field = th.dataset.sort;
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            fetchReturnRequests(1, searchQuery);
        });
    });

    window.addEventListener('resize', debounce(checkIfMobile, 100));

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initial setup
    setupModalEventListeners();
    fetchReturnRequests();
</script>
{% endblock %}
